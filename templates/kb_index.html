
{% set page_title_suffix = "KB" %}
{% set body_class = "page-kb" %}
{% set active_page = "kb" %}
{% include "_header.html" %}

<main>
  <section class="card">
    <h2>KB（知った情報の整理）</h2>

    {% if panic == "done" %}
      <p class="muted info-message">KBの全データを削除しました。</p>
    {% elif panic == "failed" %}
      <p class="error-message">パニック削除の確認が不十分か、削除に失敗しました。</p>
    {% endif %}

    {% if search_error == "empty" %}
      <p class="error-message">検索ワードが空です。</p>
    {% endif %}

    <!-- フリーワード検索 -->
    <div class="section-title">フリーワード検索</div>
    <form method="get" action="/kb/search">
      <div class="form-row">
        <label>地域：</label>
        <select name="region_id">
          <option value="">（すべて）</option>
          {% for r in regions %}
            <option value="{{ r.id }}" {% if search_region_id and search_region_id == r.id %}selected{% endif %}>
              {{ r.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-row">
        <label>検索：</label>
        <input type="text" name="q" value="{{ search_q or '' }}" placeholder="例：テスト、メモの単語、サービス名 など">
      </div>

      <div class="form-row">
        <button type="submit" class="btn-primary">検索</button>
        <!-- ★②：見た目を揃えるため a ではなく button にする -->
        <button type="button" class="btn-secondary" onclick="window.location.href='/kb'">リセット</button>
      </div>
    </form>

    {% if search_results %}
      <div class="section-title kb-section-top">検索結果（{{ search_results|length }}件）</div>
      <div class="thread-results">
        {% for p in search_results %}
          {% set st = stores_map.get(p.store_id) %}
          {% set rg = regions_map.get(st.region_id) if st else None %}
          <div class="result">
            <div class="result-id">
              <a href="/kb/person/{{ p.id }}">{{ p.name }}</a>
              {% if p.age %}／ {{ p.age }}歳{% endif %}
              {% if p.height_cm %}／ {{ p.height_cm }}cm{% endif %}
              {% if p.cup %}／ {{ p.cup }}{% endif %}
            </div>
            <div class="muted">
              {% if rg %}{{ rg.name }}{% endif %}
              {% if st %}／ {{ st.name }}{% endif %}
              {% if p.services %}／ サービス: {{ p.services }}{% endif %}
              {% if p.tags %}／ タグ: {{ p.tags }}{% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </section>

  <!-- パニックボタン -->
  <section class="card">
    <div class="section-title">パニックボタン（全削除）</div>
    <p class="muted">
      事故・緊急時向けです。KBの<strong>地域・店舗・人物・利用ログ</strong>をすべて削除します。
    </p>

    <form method="post" action="/kb/panic_delete_all"
          onsubmit="return confirm('KBの全データ（地域/店舗/人物/利用ログ）を削除します。よろしいですか？');">
      <div class="form-row">
        <label>
          <input id="kb_panic_check" type="checkbox" name="confirm_check" value="1">
          すべて削除されることを理解しました
        </label>
      </div>

      <!-- ★①：チェックしないと押せない -->
      <div class="form-row">
        <button id="kb_panic_btn" type="submit" class="btn-secondary" disabled>全削除を実行</button>
      </div>
    </form>

    <script>
      (function () {
        const chk = document.getElementById("kb_panic_check");
        const btn = document.getElementById("kb_panic_btn");
        if (!chk || !btn) return;
        const sync = () => { btn.disabled = !chk.checked; };
        chk.addEventListener("change", sync);
        sync();
      })();
    </script>
  </section>

  <!-- 通常のツリー -->
  <section class="card">
    <div class="section-title">地域 → 店舗 → 人物</div>

    <h3>地域を追加</h3>
    <form method="post" action="/kb/region">
      <div class="form-row">
        <label>地域名：</label>
        <input type="text" name="name" placeholder="例：大阪">
        <button type="submit" class="btn-primary">追加</button>
      </div>
    </form>

    {% for r in regions %}
      <hr>
      <h3>{{ r.name }}</h3>

      <form method="post" action="/kb/store">
        <input type="hidden" name="region_id" value="{{ r.id }}">
        <div class="form-row">
          <label>店舗名：</label>
          <input type="text" name="name" placeholder="例：店名A">
          <button type="submit" class="btn-primary">追加</button>
        </div>
      </form>

      {% set stores = stores_by_region.get(r.id) or [] %}
      {% if stores %}
        <div class="thread-results">
          {% for s in stores %}
            <div class="result">
              <div class="result-id">
                <a href="/kb/store/{{ s.id }}">{{ s.name }}</a>
                <span class="muted">（{{ person_counts.get(s.id, 0) }}人）</span>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">店舗はまだありません。</p>
      {% endif %}
    {% endfor %}
  </section>
</main>

{% include "_footer.html" %}
