{# 005 #}
{% set page_title_suffix = "KB" %}
{% set body_class = "page-kb" %}
{% set active_page = "kb" %}
{% include "_header.html" %}

<main>
  <section class="card">
    <h2>KB（知った情報の整理）</h2>

    {% if panic == "done" %}
      <p class="muted info-message">KBの全データを削除しました。</p>
    {% elif panic == "failed" %}
      <p class="error-message">パニック削除の確認が不十分か、削除に失敗しました。</p>
    {% endif %}

    {% if search_error == "empty" %}
      <p class="error-message">検索条件が空です。</p>
    {% endif %}

    <!-- 人物検索（詳細検索 + フリーワード） -->
    <div class="section-title">人物検索</div>
    <form method="get" action="/kb/search">
      <div class="form-row">
        <label>地域：</label>
        <select name="region_id">
          <option value="">（すべて）</option>
          {% for r in regions %}
            <option value="{{ r.id }}" {% if search_region_id and search_region_id == r.id %}selected{% endif %}>
              {{ r.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-row">
        <label>予算（合計）：</label>
        <div class="kb-sizes">
          <select name="budget_min">
            <option value="" {% if not search_budget_min %}selected{% endif %}>下限なし</option>
            <option value="5000" {% if search_budget_min == "5000" %}selected{% endif %}>5000</option>
            <option value="10000" {% if search_budget_min == "10000" %}selected{% endif %}>10000</option>
            <option value="15000" {% if search_budget_min == "15000" %}selected{% endif %}>15000</option>
            <option value="20000" {% if search_budget_min == "20000" %}selected{% endif %}>20000</option>
          </select>
          <span class="muted">〜</span>
          <select name="budget_max">
            <option value="" {% if not search_budget_max %}selected{% endif %}>上限なし</option>
            <option value="15000" {% if search_budget_max == "15000" %}selected{% endif %}>15000</option>
            <option value="20000" {% if search_budget_max == "20000" %}selected{% endif %}>20000</option>
            <option value="25000" {% if search_budget_max == "25000" %}selected{% endif %}>25000</option>
            <option value="30000" {% if search_budget_max == "30000" %}selected{% endif %}>30000</option>
            <option value="35000" {% if search_budget_max == "35000" %}selected{% endif %}>35000</option>
            <option value="40000" {% if search_budget_max == "40000" %}selected{% endif %}>40000</option>
            <option value="45000" {% if search_budget_max == "45000" %}selected{% endif %}>45000</option>
          </select>
          <span class="muted">円</span>
        </div>
        <div class="muted">※過去の利用ログのうち1回でも範囲内があればヒット</div>
      </div>

      <div class="form-row">
        <label>プロフィール：</label>
        <div>
          <div class="muted">年齢</div>
          <label><input type="checkbox" name="age" value="u20" {% if "u20" in (search_age or []) %}checked{% endif %}> 20歳以下</label>
          <label><input type="checkbox" name="age" value="21_23" {% if "21_23" in (search_age or []) %}checked{% endif %}> 21～23歳</label>
          <label><input type="checkbox" name="age" value="24_25" {% if "24_25" in (search_age or []) %}checked{% endif %}> 24～25歳</label>
          <label><input type="checkbox" name="age" value="ge26" {% if "ge26" in (search_age or []) %}checked{% endif %}> 26歳以上</label>

          <div class="muted muteded">身長</div>
          <label><input type="checkbox" name="height" value="le149" {% if "le149" in (search_height or []) %}checked{% endif %}> 149cm以下</label>
          <label><input type="checkbox" name="height" value="150_158" {% if "150_158" in (search_height or []) %}checked{% endif %}> 150～158cm</label>
          <label><input type="checkbox" name="height" value="ge159" {% if "ge159" in (search_height or []) %}checked{% endif %}> 159cm以上</label>

          <div class="muted muteded">カップ</div>
          <label><input type="checkbox" name="cup" value="leD" {% if "leD" in (search_cup or []) %}checked{% endif %}> D以下</label>
          <label><input type="checkbox" name="cup" value="EF" {% if "EF" in (search_cup or []) %}checked{% endif %}> E～F</label>
          <label><input type="checkbox" name="cup" value="geG" {% if "geG" in (search_cup or []) %}checked{% endif %}> G以上</label>

          <div class="muted muteded">ウエスト</div>
          <label><input type="checkbox" name="waist" value="le49" {% if "le49" in (search_waist or []) %}checked{% endif %}> 49以下</label>
          <label><input type="checkbox" name="waist" value="50_56" {% if "50_56" in (search_waist or []) %}checked{% endif %}> 50～56</label>
          <label><input type="checkbox" name="waist" value="57_59" {% if "57_59" in (search_waist or []) %}checked{% endif %}> 57～59</label>
          <label><input type="checkbox" name="waist" value="ge60" {% if "ge60" in (search_waist or []) %}checked{% endif %}> 60以上</label>
        </div>
      </div>

      <div class="form-row">
        <label>サービス：</label>
        <div>
          {% if svc_options %}
            <details {% if search_svc %}open{% endif %}>
              <summary class="muted">サービスを選択（{{ svc_options|length }}件）</summary>
              <div class="kb-tags-box">
                {% for s in svc_options %}
                  <label class="kb-tag-chip">
                    <input type="checkbox" name="svc" value="{{ s }}"
                      {% if s in (search_svc or []) %}checked{% endif %}>
                    {{ s }}
                  </label>
                {% endfor %}
              </div>
            </details>
          {% else %}
            <span class="muted">サービス候補はまだありません。</span>
          {% endif %}
        </div>
      </div>

      <div class="form-row">
        <label>タグ：</label>
        <div>
          {% if tag_options %}
            <details {% if search_tag %}open{% endif %}>
              <summary class="muted">タグを選択（{{ tag_options|length }}件）</summary>
              <div class="kb-tags-box">
                {% for t in tag_options %}
                  <label class="kb-tag-chip">
                    <input type="checkbox" name="tag" value="{{ t }}"
                      {% if t in (search_tag or []) %}checked{% endif %}>
                    {{ t }}
                  </label>
                {% endfor %}
              </div>
            </details>
          {% else %}
            <span class="muted">タグ候補はまだありません。</span>
          {% endif %}
        </div>
      </div>

      <div class="form-row">
        <label>フリーワード：</label>
        <input type="text" name="q" value="{{ search_q or '' }}" placeholder="例：メモの単語、サービス名、タグ など">
      </div>

      <div class="form-row">
        <button type="submit" class="btn-primary">検索</button>
        <button type="button" class="btn-secondary" onclick="window.location.href='/kb'">リセット</button>
      </div>

      <div class="muted">※何も指定せず検索すると全員表示になります（上限500件）。</div>
    </form>

    {% if search_results is not none %}
      <div class="section-title kb-section-top">検索結果（{{ search_total_count or (search_results|length) }}件）</div>
      {% if search_truncated %}
        <p class="muted">表示件数が多いため先頭500件のみ表示しています。条件を絞ってください。</p>
      {% endif %}
      <div class="thread-results">
        {% for p in search_results %}
          {% set st = (stores_map or {}).get(p.store_id) %}
          {% set rg = (regions_map or {}).get(st.region_id) if st else None %}
          {% set avg = (rating_avg_map or {}).get(p.id) %}
          <div class="result">
            <div class="result-id">
              <a href="/kb/person/{{ p.id }}">{{ p.name }}</a>
              {% if p.services %}／{{ p.services }}{% endif %}
              {% if p.age %}／{{ p.age }}歳{% endif %}
              {% if p.height_cm %}／{{ p.height_cm }}cm{% endif %}
              {% if p.cup %}／{{ p.cup }}{% endif %}
            </div>
            <div class="muted">
              {% if rg %}{{ rg.name }}{% endif %}
              {% if st %}／{{ st.name }}{% endif %}
              {% if p.services %}／サービス:{{ p.services }}{% endif %}
              {% if p.tags %}／タグ:{{ p.tags }}{% endif %}
            </div>

            {% if avg is not none %}
              <div class="muted mutede">平均評価：{{ "%.2f"|format(avg) }}</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </section>

  <!-- パニックボタン -->
  <section class="card">
    <div class="section-title">パニックボタン（全削除）</div>
    <p class="muted">
      事故・緊急時向けです。KBの<strong>地域・店舗・人物・利用ログ</strong>をすべて削除します。
    </p>

    <form method="post" action="/kb/panic_delete_all"
          onsubmit="return confirm('KBの全データ（地域/店舗/人物/利用ログ）を削除します。よろしいですか？');">
      <div class="form-row">
        <label>
          <input id="kb_panic_check" type="checkbox" name="confirm_check" value="1">
          すべて削除されることを理解しました
        </label>
      </div>

      <div class="form-row">
        <button id="kb_panic_btn" type="submit" class="btn-secondary" disabled>全削除を実行</button>
      </div>
    </form>

    <script>
      (function () {
        const chk = document.getElementById("kb_panic_check");
        const btn = document.getElementById("kb_panic_btn");
        if (!chk || !btn) return;
        const sync = () => { btn.disabled = !chk.checked; };
        chk.addEventListener("change", sync);
        sync();
      })();
    </script>
  </section>

  <!-- 通常のツリー -->
  <section class="card">
    <div class="section-title">地域 → 店舗 → 人物</div>

    <h3>地域を追加</h3>
    <form method="post" action="/kb/region">
      <div class="form-row">
        <label>地域名：</label>
        <input type="text" name="name" placeholder="例：大阪">
        <button type="submit" class="btn-primary">追加</button>
      </div>
    </form>

    {% for r in regions %}
      <hr>
      <h3>{{ r.name }}</h3>

      <form method="post" action="/kb/store">
        <input type="hidden" name="region_id" value="{{ r.id }}">
        <div class="form-row">
          <label>店舗名：</label>
          <input type="text" name="name" placeholder="例：店名A">
          <button type="submit" class="btn-primary">追加</button>
        </div>
      </form>

      {% set stores = (stores_by_region.get(r.id) if stores_by_region else []) or [] %}
      {% if stores %}
        <div class="thread-results">
          {% for s in stores %}
            <div class="result">
              <div class="result-id">
                <a href="/kb/store/{{ s.id }}">{{ s.name }}</a>
                <span class="muted">（{{ (person_counts or {}).get(s.id, 0) }}人）</span>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">店舗はまだありません。</p>
      {% endif %}
    {% endfor %}
  </section>
</main>

{% include "_footer.html" %}
