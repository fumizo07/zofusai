{# 015 #}
{% set page_title_suffix = "KB" %}
{% set body_class = "page-kb" %}
{% set active_page = "kb" %}
{% include "_header.html" %}
{% set kb_diary_filter_js = true %}

{% set search_region_id = search_region_id|default('') %}
{% set search_budget_min = search_budget_min|default('') %}
{% set search_budget_max = search_budget_max|default('') %}
{% set search_age = search_age|default([]) %}
{% set search_height = search_height|default([]) %}
{% set search_cup = search_cup|default([]) %}
{% set search_waist = search_waist|default([]) %}
{% set search_svc = search_svc|default([]) %}
{% set search_tag = search_tag|default([]) %}
{% set svc_options = svc_options|default([]) %}
{% set tag_options = tag_options|default([]) %}
{% set search_q = search_q|default('') %}
{% set search_total_count = search_total_count|default(None) %}
{% set search_truncated = search_truncated|default(False) %}

{% set import_status = import_status|default('') %}
{% set import_error = import_error|default('') %}

<main>
  <section class="card">
    <h2>KB(知った情報の整理)</h2>

    {% if import_status == "done" %}
      <p class="muted info-message">バックアップをインポートしました。</p>
    {% elif import_status == "failed" %}
      <p class="error-message">
        バックアップのインポートに失敗しました。
        {% if import_error %}<span class="muted">（{{ import_error }}）</span>{% endif %}
      </p>
    {% endif %}

    {% if panic == "done" %}
      <p class="muted info-message">KBの全データを削除しました。</p>
    {% elif panic == "failed" %}
      <p class="error-message">パニック削除の確認が不十分か、削除に失敗しました。</p>
    {% endif %}

    {% if search_error == "empty" %}
      <p class="error-message">検索条件が空です。</p>
    {% endif %}

    <!-- 人物検索（詳細検索 + フリーワード） -->
    <div class="section-title">人物検索</div>
    <form method="get" action="/kb/search">
      <div class="form-row">
        <label>地域：</label>
        <select name="region_id">
          <option value="">（すべて）</option>
          {% for r in regions %}
            <option value="{{ r.id }}" {% if search_region_id and search_region_id == r.id %}selected{% endif %}>
              {{ r.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-row">
        <label>予算（合計）：</label>
        <div class="kb-sizes">
          <select name="budget_min">
            <option value="" {% if not search_budget_min %}selected{% endif %}>下限なし</option>
            <option value="5000" {% if search_budget_min == "5000" %}selected{% endif %}>5,000</option>
            <option value="10000" {% if search_budget_min == "10000" %}selected{% endif %}>10,000</option>
            <option value="15000" {% if search_budget_min == "15000" %}selected{% endif %}>15,000</option>
            <option value="20000" {% if search_budget_min == "20000" %}selected{% endif %}>20,000</option>
          </select>
          <span class="muted">〜</span>
          <select name="budget_max">
            <option value="" {% if not search_budget_max %}selected{% endif %}>上限なし</option>
            <option value="15000" {% if search_budget_max == "15000" %}selected{% endif %}>15,000</option>
            <option value="20000" {% if search_budget_max == "20000" %}selected{% endif %}>20,000</option>
            <option value="25000" {% if search_budget_max == "25000" %}selected{% endif %}>25,000</option>
            <option value="30000" {% if search_budget_max == "30000" %}selected{% endif %}>30,000</option>
            <option value="35000" {% if search_budget_max == "35000" %}selected{% endif %}>35,000</option>
            <option value="40000" {% if search_budget_max == "40000" %}selected{% endif %}>40,000</option>
            <option value="45000" {% if search_budget_max == "45000" %}selected{% endif %}>45,000</option>
          </select>
          <span class="muted">円</span>
        </div>
        <div class="muted">※過去の利用ログのうち1回でも範囲内があればヒット</div>
      </div>

      <div class="form-row">
        <label>プロフィール：</label>
        <div>
          <div class="muted">年齢</div>
          <label><input type="checkbox" name="age" value="u20" {% if "u20" in search_age %}checked{% endif %}> 20歳以下</label>
          <label><input type="checkbox" name="age" value="21_23" {% if "21_23" in search_age %}checked{% endif %}> 21～23歳</label>
          <label><input type="checkbox" name="age" value="24_25" {% if "24_25" in search_age %}checked{% endif %}> 24～25歳</label>
          <label><input type="checkbox" name="age" value="ge26" {% if "ge26" in search_age %}checked{% endif %}> 26歳以上</label>

          <div class="muted">身長</div>
          <label><input type="checkbox" name="height" value="le149" {% if "le149" in search_height %}checked{% endif %}> 149cm以下</label>
          <label><input type="checkbox" name="height" value="150_158" {% if "150_158" in search_height %}checked{% endif %}> 150～158cm</label>
          <label><input type="checkbox" name="height" value="ge159" {% if "ge159" in search_height %}checked{% endif %}> 159cm以上</label>

          <div class="muted">胸</div>
          <label><input type="checkbox" name="cup" value="leD" {% if "leD" in search_cup %}checked{% endif %}> Dカップ以下</label>
          <label><input type="checkbox" name="cup" value="EF" {% if "EF" in search_cup %}checked{% endif %}> E～Fカップ</label>
          <label><input type="checkbox" name="cup" value="geG" {% if "geG" in search_cup %}checked{% endif %}> Gカップ以上</label>

          <div class="muted">ウエスト</div>
          <label><input type="checkbox" name="waist" value="le49" {% if "le49" in search_waist %}checked{% endif %}> 49cm以下</label>
          <label><input type="checkbox" name="waist" value="50_56" {% if "50_56" in search_waist %}checked{% endif %}> 50～56cm</label>
          <label><input type="checkbox" name="waist" value="57_59" {% if "57_59" in search_waist %}checked{% endif %}> 57～59cm</label>
          <label><input type="checkbox" name="waist" value="ge60" {% if "ge60" in search_waist %}checked{% endif %}> 60cm以上</label>
        </div>
      </div>

      <div class="form-row">
        <label>サービス：</label>
        <div>
          {% if svc_options %}
            <details {% if search_svc %}open{% endif %}>
              <summary class="muted">サービスを選択({{ svc_options|length }}件)</summary>
              <div class="kb-tags-box">
                {% for s in svc_options %}
                  <label class="kb-tag-chip">
                    <input type="checkbox" name="svc" value="{{ s }}" {% if s in search_svc %}checked{% endif %}>
                    {{ s }}
                  </label>
                {% endfor %}
              </div>
            </details>
          {% else %}
            <span class="muted">サービス候補はまだありません。</span>
          {% endif %}
        </div>
      </div>

      <div class="form-row">
        <label>タグ：</label>
        <div>
          {% if tag_options %}
            <details {% if search_tag %}open{% endif %}>
              <summary class="muted">タグを選択({{ tag_options|length }}件)</summary>
              <div class="kb-tags-box">
                {% for t in tag_options %}
                  <label class="kb-tag-chip">
                    <input type="checkbox" name="tag" value="{{ t }}" {% if t in search_tag %}checked{% endif %}>
                    {{ t }}
                  </label>
                {% endfor %}
              </div>
            </details>
          {% else %}
            <span class="muted">タグ候補はまだありません。</span>
          {% endif %}
        </div>
      </div>

      <div class="form-row">
        <label>フリーワード：</label>
        <input type="text" name="q" value="{{ search_q }}" placeholder="例：メモの単語、サービス名、タグ など">
      </div>

      <div class="form-row">
        <button type="submit" class="btn-primary">検索</button>
        <button type="button" class="btn-secondary" onclick="window.location.href='/kb'">リセット</button>
      </div>

      <div class="muted">※何も指定せず検索すると全員表示になります(上限500件)。</div>
    </form>

    {% if search_results is not none %}
      <div class="section-title kb-section-top">検索結果({{ search_total_count or (search_results|length) }}件)</div>
      {% if search_truncated %}
        <p class="muted">表示件数が多いため先頭500件のみ表示しています。条件を絞ってください。</p>
      {% endif %}

      <!-- 並び替え（クライアント側・再読み込みなし） -->
      <div class="form-row kb-person-sort-row">
        <label>並び替え：</label>
        <select id="kb_person_sort">
          <option value="name" selected>名前順</option>
          <option value="height">身長が低い順</option>
          <option value="cup">胸が大きい順</option>
          <option value="age">年齢が低い順</option>
          <option value="price">価格が安い順</option>
          <option value="rating">評価が高い順</option>
        </select>
        <label class="sort-checkbox-label">
          <input type="checkbox" id="kb_diary_tracked_only" name="diary_tracked" value="1">
          日記追跡中
        </label>
        <label class="sort-checkbox-label">
          <input type="checkbox" id="kb_fav_only" value="1">
          オキニ
        </label>
        <button type="button" id="kbDiaryBtnForce">今すぐ日記取得</button>
      </div>

      <div class="thread-results" id="kb_person_results">
        {% for p in search_results %}
          {% set st = (stores_map or {}).get(p.store_id) %}
          {% set rg = (regions_map or {}).get(st.region_id) if st else None %}
          {% set avg = (rating_avg_map or {}).get(p.id) %}
          {% set avg_amt = (amount_avg_map or {}).get(p.id) %}
          {% set tracked = (diary_track_map or {}).get(p.id, False) %}

          {# =========================
             日記URL（ベースURL + "/diary"）
             dto.jp の場合：
               - 取得(data-diary-url)は www.dto.jp に寄せる
               - 外部リンク(プロフ)は s.dto.jp に寄せる
             ========================= #}

          {% set base_url = (p.url or '') %}
          {% if base_url and base_url.endswith('/') %}
            {% set diary_url = base_url[:-1] ~ '/diary' %}
          {% elif base_url %}
            {% set diary_url = base_url ~ '/diary' %}
          {% else %}
            {% set diary_url = '' %}
          {% endif %}

          {# fetch用（dtoはwwwへ） #}
          {% set diary_fetch_url = diary_url %}
          {% if diary_fetch_url.startswith('https://s.dto.jp') %}
            {% set diary_fetch_url = diary_fetch_url|replace('https://s.dto.jp', 'https://www.dto.jp') %}
          {% elif diary_fetch_url.startswith('https://www.dto.jp') %}
            {% set diary_fetch_url = diary_fetch_url %}
          {% elif diary_fetch_url.startswith('https://dto.jp') %}
            {% set diary_fetch_url = diary_fetch_url|replace('https://dto.jp', 'https://www.dto.jp') %}
          {% endif %}

          {# プロフ外部リンク用（dtoはsへ） #}
          {% set profile_open_url = base_url %}
          {% if profile_open_url.startswith('https://www.dto.jp') %}
            {% set profile_open_url = profile_open_url|replace('https://www.dto.jp', 'https://s.dto.jp') %}
          {% elif profile_open_url.startswith('https://dto.jp') %}
            {% set profile_open_url = profile_open_url|replace('https://dto.jp', 'https://s.dto.jp') %}
          {% else %}
            {% set profile_open_url = profile_open_url %}
          {% endif %}

          <div class="result kb-person-result"
               data-person-id="{{ p.id }}"
               data-fav="{{ 1 if p.favorite else 0 }}"
               data-sort-name="{{ (p.name or '')|e }}"
               data-sort-rating="{{ avg if avg is not none else '' }}"
               data-sort-cup="{{ (p.cup or '')|e }}"
               data-sort-height="{{ p.height_cm if p.height_cm else '' }}"
               data-sort-price="{{ avg_amt if avg_amt is not none else '' }}"
               data-sort-age="{{ p.age if p.age else '' }}">

            {%- set thumb = (p.image_urls[0] if p.image_urls and (p.image_urls|length) > 0 else "") -%}
            {%- if thumb -%}
            <a href="/kb/person/{{ p.id }}">
              <img class="kb-person-thumb" src="{{ thumb|e }}" alt="thumb" loading="lazy" referrerpolicy="no-referrer">
            </a>
            {%- endif -%}

            <div class="kb-person-result-text">
              <div class="result-id">
                {% if tracked and diary_fetch_url %}
                  <span
                    class="kb-diary-slot"
                    data-kb-diary-slot="1"
                    data-person-id="{{ p.id }}"
                    data-diary-url="{{ diary_fetch_url }}"
                    data-diary-track="1"
                  ></span>
                {% endif %}
                <button type="button"
                  class="kb-fav-btn"
                  data-kb-fav-toggle="1"
                  data-person-id="{{ p.id }}"
                  aria-pressed="{{ 'true' if p.favorite else 'false' }}">
                  {{ '★' if p.favorite else '☆' }}
                </button>
                <a href="/kb/person/{{ p.id }}">{{ p.name }}</a>
                {%- if p.services -%}/{{ p.services }}{%- endif -%}
                {% if p.age %}/{{ p.age }}歳{% endif %}
                {%- if p.height_cm -%}/T{{ p.height_cm }}{%- endif -%}
                {% if p.bust_cm %}-{{ p.bust_cm }}{% if p.cup %}({{ p.cup }}){% endif %}{% endif %}
                {%- if p.waist_cm -%}-{{ p.waist_cm }}{%- endif -%}
                {% if p.hip_cm %}-{{ p.hip_cm }}{% endif %}
              </div>

              <div class="muted">
                {% if rg %}{{ rg.name }}{% endif %}
                {%- if st -%}/{{ st.name }}{%- endif -%}
                {% if p.tags %}/タグ:{{ p.tags }}{% endif %}
              </div>

              <div class="muted">
                {% if avg is not none %}平均評価:{{ "%.2f"|format(avg) }}{% endif %}
                {%- if avg_amt is not none -%}/平均金額:{{ "{:,}".format(avg_amt) }}円{%- endif -%}
              </div>

              {% if tracked and diary_fetch_url %}
                <div class="muted" data-kb-diary-meta="1">
                  <span data-kb-diary-checked></span><span data-kb-diary-latest></span>
                </div>
              {% endif %}

              <div class="muted">
                <a href="/kb/person/{{ p.id }}/external_search" target="_blank">外部検索で調べる</a>
                {%- if base_url -%}
                  /<a href="{{ profile_open_url|e }}" target="_blank" rel="noopener noreferrer">プロフ(外部)</a>
                {%- endif -%}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </section>

  <!-- パニックボタン -->
  <section class="card">
    <div class="section-title">パニックボタン(全削除)</div>
    <p class="muted">
      KBの<strong>地域・店舗・人物・利用ログ</strong>をすべて削除します。
    </p>

    <form method="post" action="/kb/panic_delete_all"
          onsubmit="return confirm('KBの全データ（地域/店舗/人物/利用ログ）を削除します。よろしいですか？');">
      <div class="form-row">
        <label>
          <input id="kb_panic_check" type="checkbox" name="confirm_check" value="1">
          すべて削除されることを理解しました
        </label>
      </div>

      <div class="form-row">
        <button id="kb_panic_btn" type="submit" class="btn-secondary" disabled>全削除を実行</button>
      </div>
    </form>
  </section>

  <!-- 通常のツリー -->
  <section class="card">
    <div class="section-title">地域 → 店舗 → 人物</div>

    <h3>地域を追加</h3>
    <form method="post" action="/kb/region">
      <div class="form-row">
        <label>地域名：</label>
        <input type="text" name="name" placeholder="例：大阪">
        <button type="submit" class="btn-primary">追加</button>
      </div>
    </form>

    {% for r in regions %}
      <hr>
      <h3>{{ r.name }}</h3>

      <form method="post" action="/kb/store">
        <input type="hidden" name="region_id" value="{{ r.id }}">
        <div class="form-row">
          <label>店舗名：</label>
          <input type="text" name="name" placeholder="例：店名A">
          <button type="submit" class="btn-primary">追加</button>
        </div>
      </form>

      {% set stores = (stores_by_region.get(r.id) if stores_by_region else []) or [] %}
      {% if stores %}
        <div class="thread-results">
          {% for s in stores %}
            <div class="result">
              <div class="result-id">
                <a href="/kb/store/{{ s.id }}">{{ s.name }}</a>
                <span class="muted">（{{ (person_counts or {}).get(s.id, 0) }}人）</span>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">店舗はまだありません。</p>
      {% endif %}
    {% endfor %}
  </section>

  <!-- バックアップ（コピペ運用） -->
  <section class="card">
    <div class="section-title">バックアップ(コピペ保存)</div>

    <p class="muted">
      「バックアップJSONを生成」で全データを取得し、暗号化されるメモ帳(Joplinなど)へ貼り付けて保存してください。<br>
      インポートは<strong>全置き換え</strong>です（地域/店舗/人物/利用ログが丸ごと入れ替わります）。
    </p>

    <h3>バックアップJSONを取得(コピー用)</h3>
    <div class="form-row">
      <button type="button" class="btn-primary" id="kb_backup_generate">バックアップJSONを生成</button>
      <button type="button" class="btn-secondary" id="kb_backup_copy" disabled>コピー</button>
      <a href="/kb/export" target="_blank" rel="noopener noreferrer">別タブで開く</a>
    </div>
    <div class="form-row">
      <textarea id="kb_backup_text" rows="10" readonly placeholder="ここにバックアップJSONが表示されます（生成ボタンを押してください）"></textarea>
    </div>
    <div id="kb_backup_msg" class="muted"></div>

    <hr>

    <h3>インポート(貼り付け/全置き換え)</h3>
    <form method="post" action="/kb/import"
          onsubmit="return confirm('インポートを実行します。現在のKBデータは全て削除され、貼り付けたバックアップで置き換わります。よろしいですか？');">
      <input type="hidden" name="mode" value="replace">

      <div class="form-row">
        <label class="muted">バックアップJSON：</label>
      </div>
      <div class="form-row">
        <textarea name="payload_json" rows="10" placeholder="ここにバックアップJSONを貼り付けてください"></textarea>
      </div>

      <div class="form-row">
        <label>
          <input id="kb_import_check" type="checkbox" name="confirm_check" value="1">
          全置き換え(全削除→復元)を理解しました
        </label>
      </div>

      <div class="form-row">
        <button id="kb_import_btn" type="submit" class="btn-secondary" disabled>インポートを実行</button>
      </div>
    </form>
  </section>
</main>

{% include "_footer.html" %}
