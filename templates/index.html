{# 002 #}
{% set page_title_suffix = "内部検索" %}
{% set body_class = "page-index" %}
{% set active_page = "index" %}
{% include "_header.html" %}

<main>
    {% if error_message %}
        <p class="error-message">{{ error_message }}</p>
    {% endif %}

    {% if info_message %}
        <p class="muted info-message">{{ info_message }}</p>
    {% endif %}

    <!-- 上部検索フォーム -->
    <form method="get" action="/">
        <input type="hidden" name="page" value="1">
        <label for="q">キーワード：</label><br>
        <input type="text" id="q" name="q" value="{{ keyword or '' }}" placeholder="例：テスト, キーワード など">

        <label for="thread_filter">スレURL / タイトル（任意）：</label><br>
        <input type="text" id="thread_filter" name="thread_filter" value="{{ thread_filter or '' }}" placeholder="空欄なら全スレ対象">

        <label for="per_page_top">1ページ表示件数：</label><br>
        <select id="per_page_top" name="per_page">
          {% set pp = per_page or 20 %}
          <option value="10" {% if pp == 10 %}selected{% endif %}>10</option>
          <option value="20" {% if pp == 20 %}selected{% endif %}>20</option>
          <option value="50" {% if pp == 50 %}selected{% endif %}>50</option>
          <option value="100" {% if pp == 100 %}selected{% endif %}>100</option>
        </select>

        <label for="tags">タグフィルタ（カンマ区切り）：</label><br>
        <input type="text" id="tags" name="tags" value="{{ tags_input or '' }}" placeholder="例：重要, 要確認 など">

        <label>タグ条件：</label><br>
        <label>
            <input type="radio" name="tag_mode" value="or" {% if tag_mode != 'and' %}checked{% endif %}>
            OR（いずれか含む）
        </label>
        &nbsp;
        <label>
            <input type="radio" name="tag_mode" value="and" {% if tag_mode == 'and' %}checked{% endif %}>
            AND（すべて含む）
        </label>

        <div>
            <button type="submit">検索</button>
        </div>
    </form>

    {% if keyword or tags_input or thread_filter %}
        <h2>検索結果({{ hit_count }}件)<small class="muted">／{{ shown_count }}件表示／{{ page }}/{{ last_page }}ページ／最大表示件数{{ per_page }}</small></h2>
        {% set params = {
          "q": keyword,
          "thread_filter": thread_filter,
          "tags": tags_input,
          "tag_mode": tag_mode,
          "per_page": per_page
        } %}
        {% set qs_base = params|urlencode %}

    
        {% if hit_count > 0 and last_page > 1 %}
          <div class="pagination">
            {% if page > 1 %}
              <a href="/?{{ qs_base }}&page={{ page - 1 }}">← 前へ</a>
            {% endif %}
        
            <span class="muted">page {{ page }} / {{ last_page }}</span>
        
            {% if page < last_page %}
              <a href="/?{{ qs_base }}&page={{ page + 1 }}">次へ →</a>
            {% endif %}
          </div>
        {% endif %}

        {% if results %}
            {% for thread in results %}
                {% set store_title = thread.store_title or '' %}
                <div class="thread-block" data-thread-url="{{ thread.thread_url }}">
                    <div class="thread-header">
                        <div>
                            <div class="thread-title">{{ thread.thread_title }}</div>
                            <div class="thread-url">{{ thread.thread_url }}</div>

                            {% if store_title %}
                            <div class="store-search" data-store-title="{{ store_title }}">
                                <span class="store-search-label">店舗ページ検索：</span>
                                <a href="#" class="btn-mini store-search-link" data-site="city">シティヘブン</a>
                                <a href="#" class="btn-mini store-search-link" data-site="dto">デリヘルタウン</a>
                                <a href="#" class="btn-mini store-search-link" data-site="google">Google</a>
                            </div>
                            {% endif %}
                        </div>

                        <div class="thread-actions">
                            <form method="post" action="/admin/refetch" style="display:inline;">
                                <input type="hidden" name="url" value="{{ thread.thread_url }}">
                                <button type="submit">このスレだけ再取得</button>
                            </form>
                            &nbsp;
                            <form method="post" action="/admin/fetch_next" style="display:inline;">
                                <input type="hidden" name="url" value="{{ thread.thread_url }}">
                                <button type="submit">次スレ取得</button>
                            </form>
                            &nbsp;
                            <form method="post" action="/admin/delete_thread" style="display:inline;" onsubmit="return confirm('このスレの保存データをすべて削除します。よろしいですか？');">
                                <input type="hidden" name="url" value="{{ thread.thread_url }}">
                                <button type="submit">このスレだけ削除</button>
                            </form>
                        </div>
                    </div>

                    <div class="thread-results">
                        {% for item in thread.entries %}
                            {% set post = item.root %}
                            <div class="result">
                                {% if store_title %}
                                <div class="name-store-search" data-store-title="{{ store_title }}">
                                    <span class="name-store-search-label">名前で店舗ページ検索：</span>
                                    <input type="text" name="name_keyword" placeholder="例：みかん">
                                    <button type="button" class="btn-mini name-search-btn" data-site="city">シティヘブン</button>
                                    <button type="button" class="btn-mini name-search-btn" data-site="dto">デリヘルタウン</button>
                                    <button type="button" class="btn-mini name-search-btn" data-site="google">Google</button>
                                </div>
                                {% endif %}

                                <div class="result-id">
                                    {% if post.post_no %}レス #{{ post.post_no }}{% else %}ID {{ post.id }}{% endif %}
                                    {% if post.posted_at %}／ {{ post.posted_at }}{% endif %}
                                </div>

                                <div class="result-meta">
                                    <small>{{ post.thread_url }}</small>
                                    │ <a href="/post/{{ post.id }}/edit">タグ・メモ編集</a>
                                </div>

                                {% if post.tags %}<div class="tags">タグ：{{ post.tags }}</div>{% endif %}
                                {% if post.memo %}<div class="memo">メモ：{{ post.memo }}</div>{% endif %}

                                <div class="result-text">{{- highlight(post.body, keyword) -}}</div>

                                {% if item.anchor_targets %}
                                    <div class="section-title-small">このレスが参照しているレス</div>
                                    {% for a in item.anchor_targets %}
                                        <div class="anchor-item">
                                            <div class="anchor-meta">
                                                {% if a.post_no %}#{{ a.post_no }}{% else %}レス番号不明{% endif %}
                                                {% if a.posted_at %}／ {{ a.posted_at }}{% endif %}
                                            </div>
                                            <div class="anchor-body">{{ highlight_with_links(a.body, keyword, thread.thread_url) }}</div>
                                        </div>
                                    {% endfor %}
                                {% endif %}


                                <div class="section-title">このレスへの返信ツリー</div>
                                {% if item.tree %}
                                    {% for node in item.tree %}
                                        <div class="tree-item" style="margin-left: {{ node.depth * 20 }}px;">
                                            <div class="tree-meta">
                                                {% if node.post.post_no %}#{{ node.post.post_no }}{% else %}ID {{ node.post.id }}{% endif %}
                                                {% if node.post.posted_at %}／ {{ node.post.posted_at }}{% endif %}
                                            </div>
                                            <div class="tree-body">{{- highlight(node.post.body, keyword) -}}</div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="no-result">このレスへの返信（アンカー）は見つかりませんでした。</p>
                                {% endif %}

                                {% if item.context %}
                                    <div class="section-title">このレスの前後（コンテキスト）</div>
                                    {% for c in item.context %}
                                        <div class="context-line {% if c.id == post.id %}context-line-root{% endif %}">
                                            {% if c.post_no %}#{{ c.post_no }}{% else %}ID {{ c.id }}{% endif %}
                                            {% if c.posted_at %}／ {{ c.posted_at }}{% endif %}
                                            ：{{ highlight_with_links(c.body|replace('\n', ' '), keyword, thread.thread_url) }}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                <div class="thread-header">
                        <div>
                            <div class="thread-title">{{ thread.thread_title }}</div>
                            <div class="thread-url">{{ thread.thread_url }}</div>

                            {% if store_title %}
                            <div class="store-search" data-store-title="{{ store_title }}">
                                <span class="store-search-label">店舗ページ検索：</span>
                                <a href="#" class="btn-mini store-search-link" data-site="city">シティヘブン</a>
                                <a href="#" class="btn-mini store-search-link" data-site="dto">デリヘルタウン</a>
                                <a href="#" class="btn-mini store-search-link" data-site="google">Google</a>
                            </div>
                            {% endif %}
                        </div>

                        <div class="thread-actions">
                            <form method="post" action="/admin/refetch" style="display:inline;">
                                <input type="hidden" name="url" value="{{ thread.thread_url }}">
                                <button type="submit">このスレだけ再取得</button>
                            </form>
                            &nbsp;
                            <form method="post" action="/admin/fetch_next" style="display:inline;">
                                <input type="hidden" name="url" value="{{ thread.thread_url }}">
                                <button type="submit">次スレ取得</button>
                            </form>
                            &nbsp;
                            <form method="post" action="/admin/delete_thread" style="display:inline;" onsubmit="return confirm('このスレの保存データをすべて削除します。よろしいですか？');">
                                <input type="hidden" name="url" value="{{ thread.thread_url }}">
                                <button type="submit">このスレだけ削除</button>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}

            {# ▼追加：ページ下部（再検索の上）にもページネーションを表示 #}
            <h2>検索結果({{ hit_count }}件)<small class="muted">／{{ shown_count }}件表示／{{ page }}/{{ last_page }}ページ／最大表示件数{{ per_page }}</small></h2>
            {% if hit_count > 0 and last_page > 1 %}
              <div class="pagination">
                {% if page > 1 %}
                  <a href="/?{{ qs_base }}&page={{ page - 1 }}">← 前へ</a>
                {% endif %}

                <span class="muted">page {{ page }} / {{ last_page }}</span>

                {% if page < last_page %}
                  <a href="/?{{ qs_base }}&page={{ page + 1 }}">次へ →</a>
                {% endif %}
              </div>
            {% endif %}

        {% else %}
            {% if not error_message %}
                <p class="no-result">該当する投稿は見つかりませんでした。</p>
            {% endif %}
        {% endif %}
    {% else %}
        <p class="no-result">上のフォームに条件を入力して検索してみてください。</p>
    {% endif %}

    

    {% if (keyword or tags_input or thread_filter) and results %}
        <h2>再検索</h2>
        <form method="get" action="/">
            <input type="hidden" name="page" value="1">
            <input type="hidden" name="per_page" value="{{ per_page or 20 }}">
            
            <div class="inner-flex-box">
                <label for="q_bottom">キーワード：</label>
                <input type="text" id="q_bottom" name="q" value="{{ keyword or '' }}" placeholder="例：テスト, キーワード など">
            </div>

            <div class="inner-flex-box">
                <label for="thread_filter_bottom">スレURL / タイトル（任意）：</label><br>
                <input type="text" id="thread_filter_bottom" name="thread_filter" value="{{ thread_filter or '' }}" placeholder="空欄なら全スレ対象">
            </div>

            <div class="inner-flex-box">
                <label for="per_page_top">1ページ表示件数：</label><br>
                <select id="per_page_top" name="per_page">
                  {% set pp = per_page or 20 %}
                  <option value="10" {% if pp == 10 %}selected{% endif %}>10</option>
                  <option value="20" {% if pp == 20 %}selected{% endif %}>20</option>
                  <option value="50" {% if pp == 50 %}selected{% endif %}>50</option>
                  <option value="100" {% if pp == 100 %}selected{% endif %}>100</option>
                </select>
            </div>

            <div class="inner-flex-box">
                <label for="tags_bottom">タグフィルタ（カンマ区切り）：</label><br>
                <input type="text" id="tags_bottom" name="tags" value="{{ tags_input or '' }}" placeholder="例：重要, 要確認 など">
            </div>

            <label>タグ条件：</label><br>
            <label>
                <input type="radio" name="tag_mode" value="or" {% if tag_mode != 'and' %}checked{% endif %}>
                OR（いずれか含む）
            </label>
            &nbsp;
            <label>
                <input type="radio" name="tag_mode" value="and" {% if tag_mode == 'and' %}checked{% endif %}>
                AND（すべて含む）
            </label>

            <div>
                <button type="submit">検索</button>
            </div>
        </form>
    {% endif %}
</main>



{% include "_footer.html" %}
