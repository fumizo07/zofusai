{% set page_title_suffix = "内部検索" %}
{% set body_class = "page-index" %}
{% set active_page = "index" %}
{% include "_header.html" %}

<main>
    {% if error_message %}
        <p class="error-message">{{ error_message }}</p>
    {% endif %}

    <!-- 上部検索フォーム -->
    <form method="get" action="/">
        <label for="q">キーワード：</label><br>
        <input
            type="text"
            id="q"
            name="q"
            value="{{ keyword or '' }}"
            placeholder="例：テスト, キーワード など"
        >

        <label for="thread_filter">スレURL / タイトル（任意）：</label><br>
        <input
            type="text"
            id="thread_filter"
            name="thread_filter"
            value="{{ thread_filter or '' }}"
            placeholder="空欄なら全スレ対象"
        >

        <label for="tags">タグフィルタ（カンマ区切り）：</label><br>
        <input
            type="text"
            id="tags"
            name="tags"
            value="{{ tags_input or '' }}"
            placeholder="例：重要, 要確認 など"
        >

        <label>タグ条件：</label><br>
        <label>
            <input type="radio" name="tag_mode" value="or" {% if tag_mode != 'and' %}checked{% endif %}>
            OR（いずれか含む）
        </label>
        &nbsp;
        <label>
            <input type="radio" name="tag_mode" value="and" {% if tag_mode == 'and' %}checked{% endif %}>
            AND（すべて含む）
        </label>

        <div style="margin-top:8px;">
            <button type="submit">検索</button>
        </div>
    </form>

    {% if keyword or tags_input or thread_filter %}
        <h2>検索結果（{{ hit_count }}件）</h2>

        {% if results %}
            {% for thread in results %}
                {% set store_title = thread.thread_title or '' %}
                <div class="thread-block">
                    <div class="thread-header">
                        <div>
                            <div class="thread-title">{{ thread.thread_title }}</div>
                            <div class="thread-url">{{ thread.thread_url }}</div>

                            {# ★ スレタイトル近くに「店舗ページ検索」 #}
                            {% if store_title %}
                            <div class="store-search" style="margin-top:4px; font-size:13px;">
                                <span style="margin-right:4px;">店舗ページ検索：</span>
                                <a
                                    href="https://www.google.com/search?q={{ ('site:cityheaven.net ' ~ store_title)|urlencode }}"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="btn-mini"
                                >
                                    シティヘブン
                                </a>
                                <a
                                    href="https://www.google.com/search?q={{ ('デリヘルタウン ' ~ store_title)|urlencode }}"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="btn-mini"
                                    style="margin-left:4px;"
                                >
                                    デリヘルタウン
                                </a>
                                <a
                                    href="https://www.google.com/search?q={{ store_title|urlencode }}"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="btn-mini"
                                    style="margin-left:4px;"
                                >
                                    Google
                                </a>
                            </div>
                            {% endif %}
                            {# ★ ここまで 店舗ページ検索 #}
                        </div>
                        <div class="thread-actions">
                            <form method="post" action="/admin/refetch" style="display:inline;">
                                <input type="hidden" name="url" value="{{ thread.thread_url }}">
                                <button type="submit">このスレだけ再取得</button>
                            </form>
                            &nbsp;
                            <form method="post" action="/admin/fetch_next" style="display:inline;">
                                <input type="hidden" name="url" value="{{ thread.thread_url }}">
                                <button type="submit">次スレ取得</button>
                            </form>
                            &nbsp;
                            <form method="post" action="/admin/delete_thread" style="display:inline;" onsubmit="return confirm('このスレの保存データをすべて削除します。よろしいですか？');">
                                <input type="hidden" name="url" value="{{ thread.thread_url }}">
                                <button type="submit">このスレだけ削除</button>
                            </form>
                        </div>
                    </div>

                    <div class="thread-results">
                        {% for item in thread.entries %}
                            {% set post = item.root %}
                            <div class="result">

                                {# ★ 各ヒットレスの一番上に「名前で店舗ページ検索」 #}
                                {% if store_title %}
                                <div class="name-store-search"
                                     data-store-title="{{ store_title }}"
                                     style="margin-bottom:4px; font-size:13px; display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
                                    <span style="min-width:140px;">名前で店舗ページ検索：</span>
                                    <input
                                        type="text"
                                        name="name_keyword"
                                        placeholder="例：さやか"
                                        style="flex:1 1 160px; max-width:220px;"
                                    >
                                    <button type="button" class="btn-mini" data-site="city">
                                        シティヘブン
                                    </button>
                                    <button type="button" class="btn-mini" data-site="deli">
                                        デリヘルタウン
                                    </button>
                                    <button type="button" class="btn-mini" data-site="google">
                                        Google
                                    </button>
                                </div>
                                {% endif %}

                                <div class="result-id">
                                    {% if post.post_no %}
                                        レス #{{ post.post_no }}
                                    {% else %}
                                        ID {{ post.id }}
                                    {% endif %}
                                    {% if post.posted_at %}
                                        ／ {{ post.posted_at }}
                                    {% endif %}
                                </div>
                                <div class="result-meta">
                                    <small>{{ post.thread_url }}</small>
                                    │ <a href="/post/{{ post.id }}/edit">タグ・メモ編集</a>
                                </div>
                                {% if post.tags %}
                                    <div class="tags">タグ：{{ post.tags }}</div>
                                {% endif %}
                                {% if post.memo %}
                                    <div class="memo">メモ：{{ post.memo }}</div>
                                {% endif %}

                                <div class="result-text">{{- highlight(post.body, keyword) -}}</div>

                                {% if item.anchor_targets %}
                                    <div class="section-title">このレスが参照しているレス</div>
                                    {% for a in item.anchor_targets %}
                                        <div class="context-line">
                                            {% if a.post_no %}
                                                #{{ a.post_no }}
                                            {% else %}
                                                ID {{ a.id }}
                                            {% endif %}
                                            {% if a.posted_at %}
                                                ／ {{ a.posted_at }}
                                            {% endif %}
                                            ：{{ highlight(a.body|replace('\n', ' '), keyword) }}
                                        </div>
                                    {% endfor %}
                                {% endif %}

                                <div class="section-title">このレスへの返信ツリー</div>
                                {% if item.tree %}
                                    {% for node in item.tree %}
                                        <div class="tree-item" style="margin-left: {{ node.depth * 20 }}px;">
                                            <div class="tree-meta">
                                                {% if node.post.post_no %}
                                                    #{{ node.post.post_no }}
                                                {% else %}
                                                    ID {{ node.post.id }}
                                                {% endif %}
                                                {% if node.post.posted_at %}
                                                    ／ {{ node.post.posted_at }}
                                                {% endif %}
                                            </div>
                                            <div class="tree-body">{{- highlight(node.post.body, keyword) -}}</div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="no-result">このレスへの返信（アンカー）は見つかりませんでした。</p>
                                {% endif %}

                                {% if item.context %}
                                    <div class="section-title">このレスの前後（コンテキスト）</div>
                                    {% for c in item.context %}
                                        <div class="context-line {% if c.id == post.id %}context-line-root{% endif %}">
                                            {% if c.post_no %}
                                                #{{ c.post_no }}
                                            {% else %}
                                                ID {{ c.id }}
                                            {% endif %}
                                            {% if c.posted_at %}
                                                ／ {{ c.posted_at }}
                                            {% endif %}
                                            ：{{ highlight(c.body|replace('\n', ' '), keyword) }}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            {% if not error_message %}
                <p class="no-result">該当する投稿は見つかりませんでした。</p>
            {% endif %}
        {% endif %}
    {% else %}
        <p class="no-result">上のフォームに条件を入力して検索してみてください。</p>
    {% endif %}

    {# ★ここから：下部フォームは「結果が出ている時だけ」表示 #}
    {% if (keyword or tags_input or thread_filter) and results %}
        <h2>再検索</h2>
        <form method="get" action="/">
            <label for="q_bottom">キーワード：</label><br>
            <input
                type="text"
                id="q_bottom"
                name="q"
                value="{{ keyword or '' }}"
                placeholder="例：テスト, キーワード など"
            >

            <label for="thread_filter_bottom">スレURL / タイトル（任意）：</label><br>
            <input
                type="text"
                id="thread_filter_bottom"
                name="thread_filter"
                value="{{ thread_filter or '' }}"
                placeholder="空欄なら全スレ対象"
            >

            <label for="tags_bottom">タグフィルタ（カンマ区切り）：</label><br>
            <input
                type="text"
                id="tags_bottom"
                name="tags"
                value="{{ tags_input or '' }}"
                placeholder="例：重要, 要確認 など"
            >

            <label>タグ条件：</label><br>
            <label>
                <input type="radio" name="tag_mode" value="or" {% if tag_mode != 'and' %}checked{% endif %}>
                OR（いずれか含む）
            </label>
            &nbsp;
            <label>
                <input type="radio" name="tag_mode" value="and" {% if tag_mode == 'and' %}checked{% endif %}>
                AND（すべて含む）
            </label>

            <div style="margin-top:8px;">
                <button type="submit">検索</button>
            </div>
        </form>
    {% endif %}
    {# ★ここまで #}
</main>

<script>
/**
 * 「名前で店舗ページ検索」用
 * 各 .name-store-search ボックスごとに
 * 店舗名（data-store-title）＋名前入力値で検索クエリを作る
 */
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".name-store-search").forEach(function(box) {
        const storeTitle = (box.dataset.storeTitle || "").trim();
        const input = box.querySelector('input[name="name_keyword"]');
        if (!input || !storeTitle) {
            return;
        }

        box.querySelectorAll("button[data-site]").forEach(function(btn) {
            btn.addEventListener("click", function() {
                const name = (input.value || "").trim();
                if (!name) {
                    alert("名前を入力してください。");
                    return;
                }

                const site = btn.getAttribute("data-site");
                let query = "";
                if (site === "city") {
                    query = "site:cityheaven.net " + storeTitle + " " + name;
                } else if (site === "deli") {
                    query = "デリヘルタウン " + storeTitle + " " + name;
                } else {
                    query = storeTitle + " " + name;
                }

                const url = "https://www.google.com/search?q=" + encodeURIComponent(query);
                window.open(url, "_blank", "noopener");
            });
        });
    });
});

/**
 * 内部検索結果のコンテキスト行に対しても「もっと読む」折りたたみを適用
 */
document.addEventListener("DOMContentLoaded", function() {
    const maxLines = 3;
    const contextLines = document.querySelectorAll(".context-line");

    contextLines.forEach(function(line) {
        const style = window.getComputedStyle(line);
        let lineHeight = parseFloat(style.lineHeight);

        if (isNaN(lineHeight)) {
            const fontSize = parseFloat(style.fontSize) || 14;
            lineHeight = fontSize * 1.5;
        }

        const maxHeight = lineHeight * maxLines;

        // 実際の高さが3行分より大きければ「もっと読む」対象
        if (line.scrollHeight > maxHeight + 2) {
            line.classList.add("context-collapsed");

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "read-more-btn";
            btn.textContent = "もっと読む";

            btn.addEventListener("click", function() {
                if (line.classList.contains("context-collapsed")) {
                    line.classList.remove("context-collapsed");
                    btn.textContent = "閉じる";
                } else {
                    line.classList.add("context-collapsed");
                    btn.textContent = "もっと読む";
                }
            });

            line.insertAdjacentElement("afterend", btn);
        }
    });
});
</script>

</body>
</html>
