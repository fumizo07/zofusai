{% set page_title_suffix = "内部検索" %}
{% set body_class = "page-index" %}
{% set active_page = "index" %}
{% include "_header.html" %}

<button class="hamburger-button" id="hamburgerButton" type="button">
    <span class="hamburger-button-inner">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
    </span>
</button>

<div class="quick-menu-overlay" id="quickMenuOverlay">
    <div class="quick-menu-panel">
        <div class="quick-menu-header">
            <div class="quick-menu-title">メニュー</div>
            <button type="button" class="quick-menu-close" aria-label="閉じる"></button>
        </div>
        <div class="quick-menu-content">
            <div class="quick-menu-section-title">再検索</div>
            <div class="quick-menu-section">
                <form method="get" action="/" class="quick-menu-form">
                    <div class="form-row">
                        <label>キーワード：</label>
                        <input type="text" name="q" value="{{ keyword or '' }}" placeholder="例：テスト, キーワード など">
                    </div>

                    <div class="form-row">
                        <label>スレURL / タイトル（任意）：</label>
                        <input type="text" name="thread_filter" value="{{ thread_filter or '' }}" placeholder="空欄なら全スレ対象">
                    </div>

                    <div class="form-row">
                        <label>タグフィルタ（カンマ区切り）：</label>
                        <input type="text" name="tags" value="{{ tags_input or '' }}" placeholder="例：重要, 要確認 など">
                    </div>

                    <div class="form-row">
                        <label>タグ条件：</label>
                        <div>
                            <label>
                                <input type="radio" name="tag_mode" value="or" {% if tag_mode != 'and' %}checked{% endif %}>
                                OR（いずれか含む）
                            </label>
                            &nbsp;
                            <label>
                                <input type="radio" name="tag_mode" value="and" {% if tag_mode == 'and' %}checked{% endif %}>
                                AND（すべて含む）
                            </label>
                        </div>
                    </div>

                    <div class="form-row">
                        <button type="submit" class="btn-primary">この条件で検索</button>
                    </div>
                </form>
            </div>

            <div class="quick-menu-section-title">その他</div>
            <div class="quick-menu-links">
                <a href="/thread_search">外部検索</a>
            </div>
        </div>
    </div>
</div>

<main>
    {% if error_message %}
        <p class="error-message">{{ error_message }}</p>
    {% endif %}

    {% if info_message %}
        <p class="muted info-message">{{ info_message }}</p>
    {% endif %}

    <!-- 上部検索フォーム -->
    <form method="get" action="/">
        <label for="q">キーワード：</label><br>
        <input type="text" id="q" name="q" value="{{ keyword or '' }}" placeholder="例：テスト, キーワード など">

        <label for="thread_filter">スレURL / タイトル（任意）：</label><br>
        <input type="text" id="thread_filter" name="thread_filter" value="{{ thread_filter or '' }}" placeholder="空欄なら全スレ対象">

        <label for="tags">タグフィルタ（カンマ区切り）：</label><br>
        <input type="text" id="tags" name="tags" value="{{ tags_input or '' }}" placeholder="例：重要, 要確認 など">

        <label>タグ条件：</label><br>
        <label>
            <input type="radio" name="tag_mode" value="or" {% if tag_mode != 'and' %}checked{% endif %}>
            OR（いずれか含む）
        </label>
        &nbsp;
        <label>
            <input type="radio" name="tag_mode" value="and" {% if tag_mode == 'and' %}checked{% endif %}>
            AND（すべて含む）
        </label>

        <div>
            <button type="submit">検索</button>
        </div>
    </form>

    {% if keyword or tags_input or thread_filter %}
        <h2>検索結果（{{ hit_count }}件）</h2>

        {% if results %}
            {% for thread in results %}
                {% set store_title = thread.store_title or '' %}
                <div class="thread-block" data-thread-url="{{ thread.thread_url }}">
                    <div class="thread-header">
                        <div>
                            <div class="thread-title">{{ thread.thread_title }}</div>
                            <div class="thread-url">{{ thread.thread_url }}</div>

                            {% if store_title %}
                            <div class="store-search" data-store-title="{{ store_title }}">
                                <span class="store-search-label">店舗ページ検索：</span>
                                <a href="#" class="btn-mini store-search-link" data-site="city">シティヘブン</a>
                                <a href="#" class="btn-mini store-search-link" data-site="dto">デリヘルタウン</a>
                                <a href="#" class="btn-mini store-search-link" data-site="google">Google</a>
                            </div>
                            {% endif %}
                        </div>

                        <div class="thread-actions">
                            <form method="post" action="/admin/refetch" style="display:inline;">
                                <input type="hidden" name="url" value="{{ thread.thread_url }}">
                                <button type="submit">このスレだけ再取得</button>
                            </form>
                            &nbsp;
                            <form method="post" action="/admin/fetch_next" style="display:inline;">
                                <input type="hidden" name="url" value="{{ thread.thread_url }}">
                                <button type="submit">次スレ取得</button>
                            </form>
                            &nbsp;
                            <form method="post" action="/admin/delete_thread" style="display:inline;" onsubmit="return confirm('このスレの保存データをすべて削除します。よろしいですか？');">
                                <input type="hidden" name="url" value="{{ thread.thread_url }}">
                                <button type="submit">このスレだけ削除</button>
                            </form>
                        </div>
                    </div>

                    <div class="thread-results">
                        {% for item in thread.entries %}
                            {% set post = item.root %}
                            <div class="result">
                                {% if store_title %}
                                <div class="name-store-search" data-store-title="{{ store_title }}">
                                    <span class="name-store-search-label">名前で店舗ページ検索：</span>
                                    <input type="text" name="name_keyword" placeholder="例：みかん">
                                    <button type="button" class="btn-mini name-search-btn" data-site="city">シティヘブン</button>
                                    <button type="button" class="btn-mini name-search-btn" data-site="dto">デリヘルタウン</button>
                                    <button type="button" class="btn-mini name-search-btn" data-site="google">Google</button>
                                </div>
                                {% endif %}

                                <div class="result-id">
                                    {% if post.post_no %}レス #{{ post.post_no }}{% else %}ID {{ post.id }}{% endif %}
                                    {% if post.posted_at %}／ {{ post.posted_at }}{% endif %}
                                </div>

                                <div class="result-meta">
                                    <small>{{ post.thread_url }}</small>
                                    │ <a href="/post/{{ post.id }}/edit">タグ・メモ編集</a>
                                </div>

                                {% if post.tags %}<div class="tags">タグ：{{ post.tags }}</div>{% endif %}
                                {% if post.memo %}<div class="memo">メモ：{{ post.memo }}</div>{% endif %}

                                <div class="result-text">{{- highlight(post.body, keyword) -}}</div>

                                {% if item.anchor_targets %}
                                    <div class="section-title">このレスが参照しているレス</div>
                                    {% for a in item.anchor_targets %}
                                        <div class="context-line">
                                            {% if a.post_no %}#{{ a.post_no }}{% else %}ID {{ a.id }}{% endif %}
                                            {% if a.posted_at %}／ {{ a.posted_at }}{% endif %}
                                            ：{{ highlight_with_links(a.body|replace('\n', ' '), keyword, thread.thread_url) }}
                                        </div>
                                    {% endfor %}
                                {% endif %}

                                <div class="section-title">このレスへの返信ツリー</div>
                                {% if item.tree %}
                                    {% for node in item.tree %}
                                        <div class="tree-item" style="margin-left: {{ node.depth * 20 }}px;">
                                            <div class="tree-meta">
                                                {% if node.post.post_no %}#{{ node.post.post_no }}{% else %}ID {{ node.post.id }}{% endif %}
                                                {% if node.post.posted_at %}／ {{ node.post.posted_at }}{% endif %}
                                            </div>
                                            <div class="tree-body">{{- highlight(node.post.body, keyword) -}}</div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="no-result">このレスへの返信（アンカー）は見つかりませんでした。</p>
                                {% endif %}

                                {% if item.context %}
                                    <div class="section-title">このレスの前後（コンテキスト）</div>
                                    {% for c in item.context %}
                                        <div class="context-line {% if c.id == post.id %}context-line-root{% endif %}">
                                            {% if c.post_no %}#{{ c.post_no }}{% else %}ID {{ c.id }}{% endif %}
                                            {% if c.posted_at %}／ {{ c.posted_at }}{% endif %}
                                            ：{{ highlight_with_links(c.body|replace('\n', ' '), keyword, thread.thread_url) }}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            {% if not error_message %}
                <p class="no-result">該当する投稿は見つかりませんでした。</p>
            {% endif %}
        {% endif %}
    {% else %}
        <p class="no-result">上のフォームに条件を入力して検索してみてください。</p>
    {% endif %}

    {% if (keyword or tags_input or thread_filter) and results %}
        <h2>再検索</h2>
        <form method="get" action="/">
            <label for="q_bottom">キーワード：</label><br>
            <input type="text" id="q_bottom" name="q" value="{{ keyword or '' }}" placeholder="例：テスト, キーワード など">

            <label for="thread_filter_bottom">スレURL / タイトル（任意）：</label><br>
            <input type="text" id="thread_filter_bottom" name="thread_filter" value="{{ thread_filter or '' }}" placeholder="空欄なら全スレ対象">

            <label for="tags_bottom">タグフィルタ（カンマ区切り）：</label><br>
            <input type="text" id="tags_bottom" name="tags" value="{{ tags_input or '' }}" placeholder="例：重要, 要確認 など">

            <label>タグ条件：</label><br>
            <label>
                <input type="radio" name="tag_mode" value="or" {% if tag_mode != 'and' %}checked{% endif %}>
                OR（いずれか含む）
            </label>
            &nbsp;
            <label>
                <input type="radio" name="tag_mode" value="and" {% if tag_mode == 'and' %}checked{% endif %}>
                AND（すべて含む）
            </label>

            <div>
                <button type="submit">検索</button>
            </div>
        </form>
    {% endif %}
</main>

<!-- ★ツールチップ本体（CSSで非表示制御） -->
<div id="anchorPreviewTooltip" class="anchor-preview-tooltip" aria-hidden="true"></div>

<script>
/* =========================
   店舗名クリーニング
   - 末尾の数字
   - 末尾の丸数字（①②③…など）
   - 末尾の絵文字
   ========================= */
function normalizeStoreTitle(raw) {
    let s = (raw || "").trim();
    if (!s) return s;

    // 末尾の通常数字
    s = s.replace(/\s*\d+\s*$/g, "");

    // 末尾の丸数字・囲み数字系（①〜⑳、⓪、㉑等の一部レンジも）
    // ※環境差があるので “末尾に連続している分を削る” 方針
    s = s.replace(/[\s\u2460-\u2473\u24EA\u3251-\u325F\u32B1-\u32BF]+$/gu, "");

    // 末尾の絵文字（Extended_Pictographic）+ VS/ZWJもまとめて削る
    try {
        s = s.replace(/[\s\p{Extended_Pictographic}\uFE0F\u200D]+$/gu, "");
    } catch (e) {
        // 古い環境フォールバック：何もしない
    }

    return s.trim();
}

/* =========================
   店舗ページ検索（スレタイ横）
   ========================= */
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".store-search").forEach(function(box) {
        const rawStore = (box.dataset.storeTitle || "").trim();
        const store = normalizeStoreTitle(rawStore);
        if (!store) return;

        box.querySelectorAll(".store-search-link[data-site]").forEach(function(a) {
            a.addEventListener("click", function(e) {
                e.preventDefault();
                const site = a.getAttribute("data-site");
                let query = "";

                if (site === "city") {
                    query = "site:cityheaven.net " + store;
                } else if (site === "dto") {
                    query = "site:dto.jp " + store;
                } else {
                    query = store;
                }

                window.open("https://www.google.com/search?q=" + encodeURIComponent(query), "_blank", "noopener");
            });
        });
    });
});

/* =========================
   名前で店舗ページ検索（各レス上）
   ========================= */
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".name-store-search").forEach(function(box) {
        const rawStore = (box.dataset.storeTitle || "").trim();
        const store = normalizeStoreTitle(rawStore);
        const input = box.querySelector('input[name="name_keyword"]');
        if (!input || !store) return;

        box.querySelectorAll(".name-search-btn[data-site]").forEach(function(btn) {
            btn.addEventListener("click", function() {
                const name = (input.value || "").trim();
                if (!name) {
                    alert("名前を入力してください。");
                    return;
                }

                const site = btn.getAttribute("data-site");
                let query = "";
                if (site === "city") {
                    query = "site:cityheaven.net " + store + " " + name;
                } else if (site === "dto") {
                    query = "site:dto.jp " + store + " " + name;
                } else {
                    query = store + " " + name;
                }

                window.open("https://www.google.com/search?q=" + encodeURIComponent(query), "_blank", "noopener");
            });
        });
    });
});

/* =========================
   「もっと読む」折りたたみ
   ========================= */
document.addEventListener("DOMContentLoaded", function() {
    const maxLines = 3;
    const contextLines = document.querySelectorAll(".context-line");

    contextLines.forEach(function(line) {
        const style = window.getComputedStyle(line);
        let lineHeight = parseFloat(style.lineHeight);

        if (isNaN(lineHeight)) {
            const fontSize = parseFloat(style.fontSize) || 14;
            lineHeight = fontSize * 1.5;
        }

        const maxHeight = lineHeight * maxLines;

        if (line.scrollHeight > maxHeight + 2) {
            line.classList.add("context-collapsed");

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "read-more-btn";
            btn.textContent = "もっと読む";

            btn.addEventListener("click", function() {
                if (line.classList.contains("context-collapsed")) {
                    line.classList.remove("context-collapsed");
                    btn.textContent = "閉じる";
                } else {
                    line.classList.add("context-collapsed");
                    btn.textContent = "もっと読む";
                }
            });

            line.insertAdjacentElement("afterend", btn);
        }
    });
});

/* =========================
   ★アンカープレビュー（常にDBから取得）
   - a.anchor-link が無い/属性が無い場合もあるので補助パースを入れる
   ========================= */
document.addEventListener("DOMContentLoaded", function() {
    const tooltip = document.getElementById("anchorPreviewTooltip");
    const cache = new Map(); // key = threadUrl + "#" + no
    let activeKey = null;
    let aborter = null;
    let lastTouchKey = null;

    function escapeHtml(s) {
        return (s || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    function setTooltipHtml(html) {
        tooltip.innerHTML = html;
    }

    function showTooltipAt(x, y) {
        const pad = 12;
        const w = tooltip.offsetWidth || 320;
        const h = tooltip.offsetHeight || 120;
        const vw = window.innerWidth;
        const vh = window.innerHeight;

        let left = x + pad;
        let top = y + pad;

        if (left + w + pad > vw) left = Math.max(pad, x - w - pad);
        if (top + h + pad > vh) top = Math.max(pad, y - h - pad);

        tooltip.style.left = left + "px";
        tooltip.style.top = top + "px";
        tooltip.setAttribute("aria-hidden", "false");
    }

    function hideTooltip() {
        tooltip.setAttribute("aria-hidden", "true");
        activeKey = null;
        if (aborter) {
            aborter.abort();
            aborter = null;
        }
    }

    function getThreadUrlForAnchor(a) {
        const block = a.closest("[data-thread-url]");
        return block ? (block.getAttribute("data-thread-url") || "") : "";
    }

    function parseAnchorNo(a) {
        const dataNo = a.getAttribute("data-anchor-no");
        if (dataNo && /^\d+$/.test(dataNo)) return dataNo;

        const t = (a.textContent || "").trim();
        const m = t.match(/^>>\s*(\d+)$/);
        if (m) return m[1];

        const href = a.getAttribute("href") || "";
        const m2 = href.match(/>>\s*(\d+)/);
        if (m2) return m2[1];

        return null;
    }

    async function fetchPreview(threadUrl, no) {
        const key = threadUrl + "#" + no;
        if (cache.has(key)) return cache.get(key);

        if (aborter) aborter.abort();
        aborter = new AbortController();

        const url = "/api/post_preview?thread_url=" + encodeURIComponent(threadUrl) + "&post_no=" + encodeURIComponent(no);
        const res = await fetch(url, { signal: aborter.signal, headers: { "Accept": "application/json" }});
        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        cache.set(key, data);
        return data;
    }

    function renderLoading(no) {
        setTooltipHtml(
            '<div class="tooltip-meta">>>' + escapeHtml(no) + '</div>' +
            '<div class="tooltip-loading">読み込み中…</div>'
        );
    }

    function renderError(no) {
        setTooltipHtml(
            '<div class="tooltip-meta">>>' + escapeHtml(no) + '</div>' +
            '<div class="tooltip-error">取得できませんでした（保存されていない/DBに存在しない可能性）</div>'
        );
    }

    function renderData(no, data) {
        const posted = data && data.posted_at ? (" ／ " + escapeHtml(data.posted_at)) : "";
        const body = data && data.body ? escapeHtml(data.body) : "";
        setTooltipHtml(
            '<div class="tooltip-meta">>>' + escapeHtml(no) + posted + '</div>' +
            '<div class="tooltip-body">' + body + '</div>'
        );
    }

    function attachToAnchor(a) {
        const no = parseAnchorNo(a);
        if (!no) return;

        // できれば属性も付与（後続処理が安定）
        a.classList.add("anchor-link");
        if (!a.getAttribute("data-anchor-no")) a.setAttribute("data-anchor-no", no);

        // hover
        a.addEventListener("mouseenter", async function(e) {
            const threadUrl = getThreadUrlForAnchor(a);
            if (!threadUrl) return;

            const key = threadUrl + "#" + no;
            activeKey = key;

            renderLoading(no);
            showTooltipAt(e.clientX, e.clientY);

            try {
                const data = await fetchPreview(threadUrl, no);
                if (activeKey !== key) return;
                renderData(no, data);
                showTooltipAt(e.clientX, e.clientY);
            } catch (err) {
                if (activeKey !== key) return;
                renderError(no);
                showTooltipAt(e.clientX, e.clientY);
            }
        });

        a.addEventListener("mousemove", function(e) {
            if (tooltip.getAttribute("aria-hidden") === "false") {
                showTooltipAt(e.clientX, e.clientY);
            }
        });

        a.addEventListener("mouseleave", function() {
            hideTooltip();
        });

        // touch（スマホ）：1回目タップでプレビュー、2回目で遷移
        a.addEventListener("click", async function(e) {
            if (!("ontouchstart" in window) && navigator.maxTouchPoints === 0) return;

            const threadUrl = getThreadUrlForAnchor(a);
            if (!threadUrl) return;

            const key = threadUrl + "#" + no;
            if (lastTouchKey !== key) {
                e.preventDefault();
                lastTouchKey = key;

                renderLoading(no);
                showTooltipAt(window.innerWidth / 2, window.innerHeight / 2);

                try {
                    const data = await fetchPreview(threadUrl, no);
                    renderData(no, data);
                } catch (err) {
                    renderError(no);
                }

                // しばらく経つと解除（次タップでまたプレビューにならないように）
                setTimeout(function() {
                    if (lastTouchKey === key) lastTouchKey = null;
                    hideTooltip();
                }, 3000);
            } else {
                lastTouchKey = null; // 2回目はリンク遷移
            }
        });
    }

    // 既に highlight_with_links が a.anchor-link を作っている前提 + フォールバックで “>>数字”っぽいリンクも拾う
    document.querySelectorAll("a").forEach(function(a) {
        const t = (a.textContent || "").trim();
        if (a.classList.contains("anchor-link") || /^>>\s*\d+$/.test(t) || a.getAttribute("data-anchor-no")) {
            attachToAnchor(a);
        }
    });

    // どこかクリックで閉じる（PCで邪魔にならないように）
    document.addEventListener("click", function(e) {
        if (tooltip.getAttribute("aria-hidden") === "false") {
            if (!tooltip.contains(e.target)) {
                hideTooltip();
            }
        }
    });
});

/* =========================
   ハンバーガーメニュー開閉
   ========================= */
document.addEventListener("DOMContentLoaded", function() {
    const btn = document.getElementById("hamburgerButton");
    const overlay = document.getElementById("quickMenuOverlay");

    if (!btn || !overlay) return;

    function openMenu() {
        overlay.classList.add("open");
        btn.classList.add("open");
        document.body.classList.add("quick-menu-open");
    }

    function closeMenu() {
        overlay.classList.remove("open");
        btn.classList.remove("open");
        document.body.classList.remove("quick-menu-open");
    }

    btn.addEventListener("click", function() {
        if (overlay.classList.contains("open")) closeMenu();
        else openMenu();
    });

    overlay.addEventListener("click", function(e) {
        if (e.target === overlay) closeMenu();
    });

    const closeBtn = overlay.querySelector(".quick-menu-close");
    if (closeBtn) closeBtn.addEventListener("click", closeMenu);

    document.addEventListener("keydown", function(e) {
        if (e.key === "Escape" && overlay.classList.contains("open")) closeMenu();
    });
});
</script>

</body>
</html>
