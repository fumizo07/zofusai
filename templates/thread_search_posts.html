{% set page_title_suffix = "スレッド内検索結果" %}
{% set body_class = "page-thread-posts" %}
{# 外部検索のサブページ扱いなので active_page は thread_search に寄せる #}
{% set active_page = "thread_search" %}
{% include "_header.html" %}

{% set store_title = thread_title or title_keyword or '' %}

<main>
    <!-- 上部：スレ情報＋再検索・保存など -->
    <section class="card">
        <div class="section-title">スレッド情報</div>

        <p class="back-link">
            <a href="/thread_search?area={{ area }}&period={{ period }}&keyword={{ title_keyword|urlencode }}">
                外部検索に戻る
            </a>
        </p>

        {% if error_message %}
            <div class="error">{{ error_message }}</div>
        {% endif %}

        <div class="thread-info">
            <div>タイトル：{{ thread_title or "（取得できませんでした）" }}</div>
            <div class="thread-url">URL：{{ thread_url }}</div>
            <div>
                タイトルキーワード：<strong>{{ title_keyword or '（未指定）' }}</strong><br>
                本文キーワード：<strong>{{ post_keyword or '（未指定）' }}</strong>
            </div>

            {# ★ スレタイ近くに店舗ページ検索 #}
            {% if store_title %}
            <div class="store-search">
                <span class="store-search-label">店舗ページ検索：</span>
                <a
                    href="https://www.google.com/search?q={{ ('site:cityheaven.net ' ~ store_title)|urlencode }}"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="btn-mini"
                >
                    シティヘブン
                </a>
                <a
                    href="https://www.google.com/search?q={{ ('デリヘルタウン ' ~ store_title)|urlencode }}"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="btn-mini"
                >
                    デリヘルタウン
                </a>
                <a
                    href="https://www.google.com/search?q={{ store_title|urlencode }}"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="btn-mini"
                >
                    Google
                </a>
            </div>
            {% endif %}
            {# ★ ここまで #}
        </div>

        {% if not error_message %}
        <div style="margin-top:8px; display:flex; flex-direction:column; gap:8px;">

            <!-- このスレを保存 -->
            <div>
                <form method="post" action="/thread_search/save" style="display:inline-block;">
                    <input type="hidden" name="thread_url" value="{{ thread_url|e }}">
                    <button type="submit" class="btn-secondary">このスレを保存</button>
                </form>
            </div>

        </div>
        {% endif %}
    </section>



    <section class="card">
        <h2>別キーワードで再検索</h2>

        <!-- 同じスレで別キーワード再検索（下部） -->
        <form method="post" action="/thread_search/posts">
            <input type="hidden" name="selected_thread" value="{{ thread_url|e }}">
            <input type="hidden" name="area" value="{{ area }}">
            <input type="hidden" name="period" value="{{ period }}">

            <div class="form-row" style="margin-bottom:4px; align-items:center;">
                <label for="post_keyword_bottom" style="min-width: 140px;">本文キーワード：</label>
                <input
                    type="text"
                    id="post_keyword_bottom"
                    name="post_keyword"
                    value="{{ post_keyword|e }}"
                    style="flex:1 1 auto;"
                >
                <button type="submit" class="btn-primary">このスレで再検索</button>
            </div>

            <div class="form-row" style="align-items:center;">
                <label for="title_keyword_bottom" style="min-width: 140px;">（メモ用）タイトル検索ワード：</label>
                <input
                    type="text"
                    id="title_keyword_bottom"
                    name="title_keyword"
                    value="{{ title_keyword|e }}"
                    style="flex:1 1 auto;"
                >
            </div>
        </form>

        <h2 style="margin-top:12px;">前後スレで再検索</h2>

        <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:flex-start;">

            <!-- 前スレで再検索 -->
            <form method="post" action="/thread_search/posts"
                  style="display:flex; gap:8px; align-items:center; flex:1 1 260px;">
                <input type="hidden" name="area" value="{{ area }}">
                <input type="hidden" name="period" value="{{ period }}">
                <input type="hidden" name="post_keyword" value="{{ post_keyword|e }}">
                <input type="hidden" name="title_keyword" value="{{ title_keyword|e }}">
                <input type="hidden" name="selected_thread" value="{{ prev_thread_url or '' }}">

                <button
                    type="submit"
                    class="btn-secondary"
                    {% if not prev_thread_url %}disabled style="opacity:0.5; cursor:default;"{% endif %}
                >
                    前スレで再検索
                </button>
                <span style="font-size:12px; color:#6b7280;">
                    {% if prev_thread_url %}
                        {{ prev_thread_url }}
                    {% else %}
                        前スレが見つかりません。
                    {% endif %}
                </span>
            </form>

            <!-- 次スレで再検索 -->
            <form method="post" action="/thread_search/posts"
                  style="display:flex; gap:8px; align-items:center; flex:1 1 260px;">
                <input type="hidden" name="area" value="{{ area }}">
                <input type="hidden" name="period" value="{{ period }}">
                <input type="hidden" name="post_keyword" value="{{ post_keyword|e }}">
                <input type="hidden" name="title_keyword" value="{{ title_keyword|e }}">
                <input type="hidden" name="selected_thread" value="{{ next_thread_url or '' }}">

                <button
                    type="submit"
                    class="btn-secondary"
                    {% if not next_thread_url %}disabled style="opacity:0.5; cursor:default;"{% endif %}
                >
                    次スレで再検索
                </button>
                <span style="font-size:12px; color:#6b7280;">
                    {% if next_thread_url %}
                        {{ next_thread_url }}
                    {% else %}
                        次スレが見つかりません。
                    {% endif %}
                </span>
            </form>
        </div>
    </section>

    <!-- 下部：ヒットしたレス一覧 -->
    <section class="card">
        <div class="section-title">スレッド情報</div>

    <!-- 下部：ヒットしたレス一覧 -->
    <section class="card">
        {% if entries and not error_message %}
            <h2>ヒットしたレス（{{ entries|length }}件）</h2>

            {% for item in entries %}
                {% set post = item.root %}
                <div class="result">

                    {# ★ 各ヒットレスの一番上に「名前で店舗ページ検索」 #}
                    {% if store_title %}
                    <div class="name-store-search" data-store-title="{{ store_title }}">
                        <span class="name-store-search-label">名前で店舗ページ検索：</span>
                        <input
                            type="text"
                            name="name_keyword"
                            placeholder="例：ティアラ"
                        >
                        <button type="button" class="btn-mini" data-site="city">
                            シティヘブン
                        </button>
                        <button type="button" class="btn-mini" data-site="deli">
                            デリヘルタウン
                        </button>
                        <button type="button" class="btn-mini" data-site="google">
                            Google
                        </button>
                    </div>
                    {% endif %}

                    <div class="result-id">
                        {% if post.post_no %}
                            レス #{{ post.post_no }}
                        {% else %}
                            レス番号不明
                        {% endif %}
                        {% if post.posted_at %}
                            ／ {{ post.posted_at }}
                        {% endif %}
                    </div>
                    <div class="result-url">
                        URL：{{ thread_url }}{% if post.post_no %}（レス #{{ post.post_no }}）{% endif %}
                    </div>

                    <!-- 本文 -->
                    <div class="result-text">{{ highlight(post.body, post_keyword) }}</div>

                    {% if item.anchor_targets %}
                        <div class="section-title-small">このレスが参照しているレス</div>
                        {% for a in item.anchor_targets %}
                            <div class="anchor-item">
                                <div class="anchor-meta">
                                    {% if a.post_no %}
                                        #{{ a.post_no }}
                                    {% else %}
                                        レス番号不明
                                    {% endif %}
                                    {% if a.posted_at %}
                                        ／ {{ a.posted_at }}
                                    {% endif %}
                                </div>
                                <div class="anchor-body">{{ highlight(a.body, post_keyword) }}</div>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <div class="section-title-small">このレスへの返信ツリー</div>
                    {% if item.tree %}
                        {% for node in item.tree %}
                            <div class="tree-item" style="margin-left: {{ node.depth * 20 }}px;">
                                <div class="tree-meta">
                                    {% if node.post.post_no %}
                                        #{{ node.post.post_no }}
                                    {% else %}
                                        レス番号不明
                                    {% endif %}
                                    {% if node.post.posted_at %}
                                        ／ {{ node.post.posted_at }}
                                    {% endif %}
                                </div>
                                <div class="tree-body">{{ highlight(node.post.body, post_keyword) }}</div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-result">このレスへの返信（アンカー）は見つかりませんでした。</p>
                    {% endif %}

                    {% if item.context %}
                        <div class="section-title-small">このレスの前後（コンテキスト）</div>
                        {% for c in item.context %}
                            <div class="context-line {% if c.post_no and post.post_no and c.post_no == post.post_no %}context-line-root{% endif %}">
                                {% if c.post_no %}
                                    #{{ c.post_no }}
                                {% else %}
                                    レス番号不明
                                {% endif %}
                                {% if c.posted_at %}
                                    ／ {{ c.posted_at }}
                                {% endif %}
                                ：{{ highlight(c.body|replace('\n', ' '), post_keyword) }}
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            {% endfor %}
        {% elif not error_message %}
            <p class="no-result">指定したキーワードを含むレスは見つかりませんでした。</p>
        {% endif %}
    </section>

    {# ★ここから：ページ下部の再検索エリア #}
    {% if not error_message %}
    <section class="card">
    
    {% if not error_message %}
        <div style="margin-top:8px; display:flex; flex-direction:column; gap:8px;">

            <!-- このスレを保存 -->
            <div>
                <form method="post" action="/thread_search/save" style="display:inline-block;">
                    <input type="hidden" name="thread_url" value="{{ thread_url|e }}">
                    <button type="submit" class="btn-secondary">このスレを保存</button>
                </form>
            </div>

        </div>
      {% endif %}
      
        <h2>別キーワードで再検索</h2>

        <!-- 同じスレで別キーワード再検索（下部） -->
        <form method="post" action="/thread_search/posts">
            <input type="hidden" name="selected_thread" value="{{ thread_url|e }}">
            <input type="hidden" name="area" value="{{ area }}">
            <input type="hidden" name="period" value="{{ period }}">

            <div class="form-row" style="margin-bottom:4px; align-items:center;">
                <label for="post_keyword_bottom" style="min-width: 140px;">本文キーワード：</label>
                <input
                    type="text"
                    id="post_keyword_bottom"
                    name="post_keyword"
                    value="{{ post_keyword|e }}"
                    style="flex:1 1 auto;"
                >
                <button type="submit" class="btn-primary">このスレで再検索</button>
            </div>

            <div class="form-row" style="align-items:center;">
                <label for="title_keyword_bottom" style="min-width: 140px;">（メモ用）タイトル検索ワード：</label>
                <input
                    type="text"
                    id="title_keyword_bottom"
                    name="title_keyword"
                    value="{{ title_keyword|e }}"
                    style="flex:1 1 auto;"
                >
            </div>
        </form>

        <h2 style="margin-top:12px;">前後スレで再検索</h2>

        <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:flex-start;">

            <!-- 前スレで再検索 -->
            <form method="post" action="/thread_search/posts"
                  style="display:flex; gap:8px; align-items:center; flex:1 1 260px;">
                <input type="hidden" name="area" value="{{ area }}">
                <input type="hidden" name="period" value="{{ period }}">
                <input type="hidden" name="post_keyword" value="{{ post_keyword|e }}">
                <input type="hidden" name="title_keyword" value="{{ title_keyword|e }}">
                <input type="hidden" name="selected_thread" value="{{ prev_thread_url or '' }}">

                <button
                    type="submit"
                    class="btn-secondary"
                    {% if not prev_thread_url %}disabled style="opacity:0.5; cursor:default;"{% endif %}
                >
                    前スレで再検索
                </button>
                <span style="font-size:12px; color:#6b7280;">
                    {% if prev_thread_url %}
                        {{ prev_thread_url }}
                    {% else %}
                        前スレが見つかりません。
                    {% endif %}
                </span>
            </form>

            <!-- 次スレで再検索 -->
            <form method="post" action="/thread_search/posts"
                  style="display:flex; gap:8px; align-items:center; flex:1 1 260px;">
                <input type="hidden" name="area" value="{{ area }}">
                <input type="hidden" name="period" value="{{ period }}">
                <input type="hidden" name="post_keyword" value="{{ post_keyword|e }}">
                <input type="hidden" name="title_keyword" value="{{ title_keyword|e }}">
                <input type="hidden" name="selected_thread" value="{{ next_thread_url or '' }}">

                <button
                    type="submit"
                    class="btn-secondary"
                    {% if not next_thread_url %}disabled style="opacity:0.5; cursor:default;"{% endif %}
                >
                    次スレで再検索
                </button>
                <span style="font-size:12px; color:#6b7280;">
                    {% if next_thread_url %}
                        {{ next_thread_url }}
                    {% else %}
                        次スレが見つかりません。
                    {% endif %}
                </span>
            </form>
        </div>
    </section>
    {% endif %}
    {# ★ここまで #}
</main>

<script>
/**
 * 「名前で店舗ページ検索」用
 * 各 .name-store-search ボックスごとに
 * 店舗名（data-store-title）＋名前入力値で検索クエリを作る
 */
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".name-store-search").forEach(function(box) {
        const storeTitle = (box.dataset.storeTitle || "").trim();
        const input = box.querySelector('input[name="name_keyword"]');
        if (!input || !storeTitle) {
            return;
        }

        box.querySelectorAll("button[data-site]").forEach(function(btn) {
            btn.addEventListener("click", function() {
                const name = (input.value || "").trim();
                if (!name) {
                    alert("名前を入力してください。");
                    return;
                }

                const site = btn.getAttribute("data-site");
                let query = "";
                if (site === "city") {
                    query = "site:cityheaven.net " + storeTitle + " " + name;
                } else if (site === "deli") {
                    query = "デリヘルタウン " + storeTitle + " " + name;
                } else {
                    query = storeTitle + " " + name;
                }

                const url = "https://www.google.com/search?q=" + encodeURIComponent(query);
                window.open(url, "_blank", "noopener");
            });
        });
    });
});

/**
 * コンテキスト行が3行以上に折り返されている場合だけ
 * 「もっと読む」ボタンを出して、初期状態では折りたたむ。
 */
document.addEventListener("DOMContentLoaded", function() {
    const maxLines = 3;
    const contextLines = document.querySelectorAll(".context-line");

    contextLines.forEach(function(line) {
        const style = window.getComputedStyle(line);
        let lineHeight = parseFloat(style.lineHeight);

        if (isNaN(lineHeight)) {
            const fontSize = parseFloat(style.fontSize) || 14;
            lineHeight = fontSize * 1.5;
        }

        const maxHeight = lineHeight * maxLines;

        // 実際の高さが3行分より大きければ「もっと読む」対象
        if (line.scrollHeight > maxHeight + 2) {
            line.classList.add("context-collapsed");

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "read-more-btn";
            btn.textContent = "もっと読む";

            btn.addEventListener("click", function() {
                if (line.classList.contains("context-collapsed")) {
                    line.classList.remove("context-collapsed");
                    btn.textContent = "閉じる";
                } else {
                    line.classList.add("context-collapsed");
                    btn.textContent = "もっと読む";
                }
            });

            line.insertAdjacentElement("afterend", btn);
        }
    });
});
</script>

</body>
</html>
