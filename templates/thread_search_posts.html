{% set page_title_suffix = "スレッド内検索結果" %}
{% set body_class = "page-thread-posts" %}
{% set active_page = "thread_search" %}
{% include "_header.html" %}

{% set store_title = store_base_title or thread_title or title_keyword or '' %}

<button class="hamburger-button" id="hamburgerButton" type="button">
    <span class="hamburger-button-inner">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
    </span>
</button>

<div class="quick-menu-overlay" id="quickMenuOverlay">
    <div class="quick-menu-panel">
        <div class="quick-menu-header">
            <div class="quick-menu-title">メニュー</div>
            <button type="button" class="quick-menu-close" aria-label="閉じる"></button>
        </div>
        <div class="quick-menu-content">

            <div class="quick-menu-section">
                <div class="quick-menu-section-title">スレッド情報</div>
                <div style="font-size:13px;">
                    <div>タイトル：{{ thread_title or "（取得できませんでした）" }}</div>
                    <div class="thread-url">URL：{{ thread_url }}</div>
                    <div>
                        カテゴリ：<strong>{{ board_category_label or '（未指定）' }}</strong><br>
                        板：<strong>{{ board_label or '（未指定）' }}</strong>
                    </div>
                    <div>
                        タイトルキーワード：<strong>{{ title_keyword or '（未指定）' }}</strong><br>
                        本文キーワード：<strong>{{ post_keyword or '（未指定）' }}</strong>
                    </div>
                </div>
            </div>

            <div class="quick-menu-section">
                <div class="quick-menu-section-title">別キーワードで再検索</div>
                <form method="post" action="/thread_search/posts" class="quick-menu-form">
                    <input type="hidden" name="selected_thread" value="{{ thread_url|e }}">
                    <input type="hidden" name="area" value="{{ area }}">
                    <input type="hidden" name="period" value="{{ period }}">
                    <input type="hidden" name="board_category" value="{{ board_category|e }}">
                    <input type="hidden" name="board_id" value="{{ board_id|e }}">
                    <input type="hidden" name="title_keyword" value="{{ title_keyword|e }}">

                    <div class="form-row">
                        <label>本文キーワード：</label>
                        <input
                            type="text"
                            name="post_keyword"
                            value="{{ post_keyword|e }}"
                        >
                    </div>

                    <div class="form-row">
                        <button type="submit" class="btn-primary">このスレで再検索</button>
                    </div>
                </form>
            </div>

            {% if not error_message %}
            <div class="quick-menu-section">
                <div class="quick-menu-section-title">保存</div>
                <form method="post" action="/thread_search/save">
                    <input type="hidden" name="thread_url" value="{{ thread_url|e }}">
                    <button type="submit" class="btn-secondary">このスレを保存</button>
                </form>
            </div>
            {% endif %}

            <div class="quick-menu-section">
                <div class="quick-menu-section-title">スレ検索</div>
                <div class="quick-menu-links">
                    <a href="/thread_search?area={{ area }}&period={{ period }}&keyword={{ title_keyword|urlencode }}">
                        外部検索に戻る
                    </a>
                    <a href="/">
                        内部検索に戻る
                    </a>
                </div>
            </div>

        </div>
    </div>
</div>


<main>
    <section class="card">
        <div class="section-title">スレッド情報</div>

        <p class="back-link">
            <a href="/thread_search?area={{ area }}&period={{ period }}&keyword={{ title_keyword|urlencode }}">
                外部検索に戻る
            </a>
        </p>

        {% if error_message %}
            <div class="error">{{ error_message }}</div>
        {% endif %}

        <div class="thread-info">
            <div>タイトル：{{ thread_title or "（取得できませんでした）" }}</div>
            <div class="thread-url">URL：{{ thread_url }}</div>
            <div>
                カテゴリ：<strong>{{ board_category_label or '（未指定）' }}</strong><br>
                板：<strong>{{ board_label or '（未指定）' }}</strong>
            </div>
            <div>
                タイトルキーワード：<strong>{{ title_keyword or '（未指定）' }}</strong><br>
                本文キーワード：<strong>{{ post_keyword or '（未指定）' }}</strong>
            </div>

            {# スレタイ近くに店舗ページ検索 #}
            {% if store_title %}
            <div class="store-search">
                <span class="store-search-label">店舗ページ検索：</span>

                {% set city_url = store_cityheaven_url if store_cityheaven_url is defined and store_cityheaven_url else ("https://www.google.com/search?q=" ~ ("site:cityheaven.net " ~ store_title)|urlencode) %}
                {% set dto_url  = store_dto_url if store_dto_url is defined and store_dto_url else ("https://www.google.com/search?q=" ~ ("site:dto.jp " ~ store_title)|urlencode) %}

                <a
                    href="{{ city_url }}"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="btn-mini"
                >
                    シティヘブン
                </a>
                <a
                    href="{{ dto_url }}"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="btn-mini"
                >
                    デリヘルタウン
                </a>
                <a
                    href="https://www.google.com/search?q={{ store_title|urlencode }}"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="btn-mini"
                >
                    Google
                </a>
            </div>
            {% endif %}
        </div>
    </section>

    <section class="card">
        <h2>別キーワードで再検索</h2>

        <form method="post" action="/thread_search/posts">
            <input type="hidden" name="selected_thread" value="{{ thread_url|e }}">
            <input type="hidden" name="area" value="{{ area }}">
            <input type="hidden" name="period" value="{{ period }}">
            <input type="hidden" name="board_category" value="{{ board_category }}">
            <input type="hidden" name="board_id" value="{{ board_id }}">

            <div class="form-row" style="margin-bottom:4px; align-items:center;">
                <label for="post_keyword_bottom" style="min-width: 140px;">本文キーワード：</label>
                <input
                    type="text"
                    id="post_keyword_bottom"
                    name="post_keyword"
                    value="{{ post_keyword|e }}"
                    style="flex:1 1 auto;"
                >
                <button type="submit" class="btn-primary">このスレで再検索</button>
            </div>

            <div class="form-row" style="align-items:center;">
                <label for="title_keyword_bottom" style="min-width: 140px;">（メモ用）タイトル検索ワード：</label>
                <input
                    type="text"
                    id="title_keyword_bottom"
                    name="title_keyword"
                    value="{{ title_keyword|e }}"
                    style="flex:1 1 auto;"
                >
            </div>
        </form>

        <h2 style="margin-top:12px;">前後スレで再検索</h2>

        <div class="thread-pn-box">
            <form method="post" action="/thread_search/posts" class="thread-prev-next">
                <input type="hidden" name="area" value="{{ area }}">
                <input type="hidden" name="period" value="{{ period }}">
                <input type="hidden" name="post_keyword" value="{{ post_keyword|e }}">
                <input type="hidden" name="title_keyword" value="{{ title_keyword|e }}">
                <input type="hidden" name="selected_thread" value="{{ prev_thread_url or '' }}">
                <input type="hidden" name="board_category" value="{{ board_category }}">
                <input type="hidden" name="board_id" value="{{ board_id }}">

                <button
                    type="submit"
                    class="btn-secondary"
                    {% if not prev_thread_url %}disabled style="opacity:0.5; cursor:default;"{% endif %}
                >
                    前スレで再検索
                </button>
                <span class="thread-url">
                    {% if prev_thread_url %}
                        {{ prev_thread_url }}
                    {% else %}
                        前スレが見つかりません。
                    {% endif %}
                </span>
            </form>

            <form method="post" action="/thread_search/posts" class="thread-prev-next">
                <input type="hidden" name="area" value="{{ area }}">
                <input type="hidden" name="period" value="{{ period }}">
                <input type="hidden" name="post_keyword" value="{{ post_keyword|e }}">
                <input type="hidden" name="title_keyword" value="{{ title_keyword|e }}">
                <input type="hidden" name="selected_thread" value="{{ next_thread_url or '' }}">
                <input type="hidden" name="board_category" value="{{ board_category }}">
                <input type="hidden" name="board_id" value="{{ board_id }}">

                <button
                    type="submit"
                    class="btn-secondary"
                    {% if not next_thread_url %}disabled style="opacity:0.5; cursor:default;"{% endif %}
                >
                    次スレで再検索
                </button>
                <span class="thread-url">
                    {% if next_thread_url %}
                        {{ next_thread_url }}
                    {% else %}
                        次スレが見つかりません。
                    {% endif %}
                </span>
            </form>
        </div>

        {% if not error_message %}
        <div class="thread-save">
            <form method="post" action="/thread_search/save">
              <input type="hidden" name="thread_url" value="{{ thread_url|e }}">
              <button type="submit" class="btn-secondary">このスレを保存</button>
            </form>
        </div>
        {% endif %}
    </section>

    <section class="card">
        {% if entries and not error_message %}
            <h2>ヒットしたレス（{{ entries|length }}件）</h2>

            {% for item in entries %}
                {% set post = item.root %}
                <div class="result" {% if post.post_no %}data-post-no="{{ post.post_no }}"{% endif %}>

                    {% if store_title %}
                    <div class="name-store-search" data-store-title="{{ store_title }}">
                        <span class="name-store-search-label">名前で店舗ページ検索：</span>
                        <input
                            type="text"
                            name="name_keyword"
                            placeholder="例：みかん"
                        >
                        <button type="button" class="btn-mini" data-site="city">
                            シティヘブン
                        </button>
                        <button type="button" class="btn-mini" data-site="deli">
                            デリヘルタウン
                        </button>
                        <button type="button" class="btn-mini" data-site="google">
                            Google
                        </button>
                    </div>
                    {% endif %}

                    <div class="result-id">
                        {% if post.post_no %}
                            レス #{{ post.post_no }}
                        {% else %}
                            レス番号不明
                        {% endif %}
                        {% if post.posted_at %}
                            ／ {{ post.posted_at }}
                        {% endif %}
                    </div>
                    <div class="result-url">
                        URL：{{ thread_url }}{% if post.post_no %}（レス #{{ post.post_no }}）{% endif %}
                    </div>

                    <div class="result-text">{{ highlight(post.body, post_keyword) }}</div>

                    {% if item.anchor_targets %}
                        <div class="section-title-small">このレスが参照しているレス</div>
                        {% for a in item.anchor_targets %}
                            <div class="anchor-item" {% if a.post_no %}data-post-no="{{ a.post_no }}"{% endif %}>
                                <div class="anchor-meta">
                                    {% if a.post_no %}
                                        #{{ a.post_no }}
                                    {% else %}
                                        レス番号不明
                                    {% endif %}
                                    {% if a.posted_at %}
                                        ／ {{ a.posted_at }}
                                    {% endif %}
                                </div>
                                <div class="anchor-body">{{ highlight_with_links(a.body, post_keyword, thread_url) }}</div>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <div class="section-title-small">このレスへの返信ツリー</div>
                    {% if item.tree %}
                        {% for node in item.tree %}
                            <div class="tree-item" style="margin-left: {{ node.depth * 20 }}px;" {% if node.post.post_no %}data-post-no="{{ node.post.post_no }}"{% endif %}>
                                <div class="tree-meta">
                                    {% if node.post.post_no %}
                                        #{{ node.post.post_no }}
                                    {% else %}
                                        レス番号不明
                                    {% endif %}
                                    {% if node.post.posted_at %}
                                        ／ {{ node.post.posted_at }}
                                    {% endif %}
                                </div>
                                <div class="tree-body">{{ highlight(node.post.body, post_keyword) }}</div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-result">このレスへの返信（アンカー）は見つかりませんでした。</p>
                    {% endif %}

                    {% if item.context %}
                        <div class="section-title-small">このレスの前後（コンテキスト）</div>
                        {% for c in item.context %}
                            <div class="context-line {% if c.post_no and post.post_no and c.post_no == post.post_no %}context-line-root{% endif %}" {% if c.post_no %}data-post-no="{{ c.post_no }}"{% endif %}>
                                {% if c.post_no %}
                                    #{{ c.post_no }}
                                {% else %}
                                    レス番号不明
                                {% endif %}
                                {% if c.posted_at %}
                                    ／ {{ c.posted_at }}
                                {% endif %}
                                ：{{ highlight_with_links(c.body|replace('\n', ' '), post_keyword, thread_url) }}
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            {% endfor %}
        {% elif not error_message %}
            <p class="no-result">指定したキーワードを含むレスは見つかりませんでした。</p>
        {% endif %}
    </section>
</main>

<script>
/**
 * 「名前で店舗ページ検索」用
 */
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".name-store-search").forEach(function(box) {
        const storeTitle = (box.dataset.storeTitle || "").trim();
        const input = box.querySelector('input[name="name_keyword"]');
        if (!input || !storeTitle) {
            return;
        }

        box.querySelectorAll("button[data-site]").forEach(function(btn) {
            btn.addEventListener("click", function() {
                const name = (input.value || "").trim();
                if (!name) {
                    alert("名前を入力してください。");
                    return;
                }

                const site = btn.getAttribute("data-site");
                let query = "";
                if (site === "city") {
                    query = "site:cityheaven.net " + storeTitle + " " + name;
                } else if (site === "deli") {
                    // ★ dto.jp を site: 検索
                    query = "site:dto.jp " + storeTitle + " " + name;
                } else {
                    query = storeTitle + " " + name;
                }

                const url = "https://www.google.com/search?q=" + encodeURIComponent(query);
                window.open(url, "_blank", "noopener");
            });
        });
    });
});

/**
 * ★アンカープレビュー（title）
 */
document.addEventListener("DOMContentLoaded", function() {
    const map = new Map();

    document.querySelectorAll("[data-post-no]").forEach(function(el) {
        const no = el.getAttribute("data-post-no");
        if (!no || map.has(no)) return;

        const bodyEl = el.querySelector(".result-text, .tree-body, .anchor-body, .post-body");
        if (!bodyEl) return;

        const txt = (bodyEl.textContent || "").trim().replace(/\s+/g, " ");
        if (!txt) return;

        map.set(no, txt.slice(0, 220));
    });

    document.querySelectorAll("a.anchor-link[data-anchor-no]").forEach(function(a) {
        const no = a.getAttribute("data-anchor-no");
        if (!no) return;

        const snippet = map.get(no);
        if (snippet) {
            a.setAttribute("title", ">>" + no + " " + snippet);
        } else {
            a.setAttribute("title", ">>" + no + "（このページ内に未表示）");
        }
    });
});

/**
 * ハンバーガーメニュー開閉
 */
document.addEventListener("DOMContentLoaded", function() {
    const btn = document.getElementById("hamburgerButton");
    const overlay = document.getElementById("quickMenuOverlay");

    if (!btn || !overlay) {
        return;
    }

    function openMenu() {
        overlay.classList.add("open");
        btn.classList.add("open");
        document.body.classList.add("quick-menu-open");
    }

    function closeMenu() {
        overlay.classList.remove("open");
        btn.classList.remove("open");
        document.body.classList.remove("quick-menu-open");
    }

    btn.addEventListener("click", function() {
        if (overlay.classList.contains("open")) {
            closeMenu();
        } else {
            openMenu();
        }
    });

    overlay.addEventListener("click", function(e) {
        if (e.target === overlay) {
            closeMenu();
        }
    });

    const closeBtn = overlay.querySelector(".quick-menu-close");
    if (closeBtn) {
        closeBtn.addEventListener("click", function() {
            closeMenu();
        });
    }

    document.addEventListener("keydown", function(e) {
        if (e.key === "Escape" && overlay.classList.contains("open")) {
            closeMenu();
        }
    });
});
</script>

</body>
</html>
