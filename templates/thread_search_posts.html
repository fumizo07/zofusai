{% set page_title_suffix = "スレッド内検索結果" %}
{% set body_class = "page-thread-posts" %}
{% set active_page = "thread_search" %}
{% include "_header.html" %}

{% set store_title = store_base_title or thread_title or title_keyword or '' %}

<button class="hamburger-button" id="hamburgerButton" type="button">
    <span class="hamburger-button-inner">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
    </span>
</button>

<div class="quick-menu-overlay" id="quickMenuOverlay">
    <div class="quick-menu-panel">
        <div class="quick-menu-header">
            <div class="quick-menu-title">メニュー</div>
            <button type="button" class="quick-menu-close" aria-label="閉じる"></button>
        </div>
        <div class="quick-menu-content">

            <div class="quick-menu-section">
                <div class="quick-menu-section-title">スレッド情報</div>
                <div style="font-size:13px;">
                    <div>タイトル：{{ thread_title or "（取得できませんでした）" }}</div>
                    <div class="thread-url">URL：{{ thread_url }}</div>
                    <div>
                        カテゴリ：<strong>{{ board_category_label or '（未指定）' }}</strong><br>
                        板：<strong>{{ board_label or '（未指定）' }}</strong>
                    </div>
                    <div>
                        タイトルキーワード：<strong>{{ title_keyword or '（未指定）' }}</strong><br>
                        本文キーワード：<strong>{{ post_keyword or '（未指定）' }}</strong>
                    </div>
                </div>
            </div>

            <div class="quick-menu-section">
                <div class="quick-menu-section-title">別キーワードで再検索</div>
                <form method="post" action="/thread_search/posts" class="quick-menu-form">
                    <input type="hidden" name="selected_thread" value="{{ thread_url|e }}">
                    <input type="hidden" name="area" value="{{ area }}">
                    <input type="hidden" name="period" value="{{ period }}">
                    <input type="hidden" name="board_category" value="{{ board_category|e }}">
                    <input type="hidden" name="board_id" value="{{ board_id|e }}">
                    <input type="hidden" name="title_keyword" value="{{ title_keyword|e }}">

                    <div class="form-row">
                        <label>本文キーワード：</label>
                        <input type="text" name="post_keyword" value="{{ post_keyword|e }}">
                    </div>

                    <div class="form-row">
                        <button type="submit" class="btn-primary">このスレで再検索</button>
                    </div>
                </form>
            </div>

            {% if not error_message %}
            <div class="quick-menu-section">
                <div class="quick-menu-section-title">保存</div>
                <form method="post" action="/thread_search/save">
                    <input type="hidden" name="thread_url" value="{{ thread_url|e }}">
                    <button type="submit" class="btn-secondary">このスレを保存</button>
                </form>
            </div>
            {% endif %}

            <div class="quick-menu-section">
                <div class="quick-menu-section-title">スレ検索</div>
                <div class="quick-menu-links">
                    <a href="/thread_search?area={{ area }}&period={{ period }}&keyword={{ title_keyword|urlencode }}">
                        外部検索に戻る
                    </a>
                    <a href="/">
                        内部検索に戻る
                    </a>
                </div>
            </div>

        </div>
    </div>
</div>

<main data-thread-url="{{ thread_url|e }}">
    <section class="card">
        <div class="section-title">スレッド情報</div>

        <p class="back-link">
            <a href="/thread_search?area={{ area }}&period={{ period }}&keyword={{ title_keyword|urlencode }}">
                外部検索に戻る
            </a>
        </p>

        {% if error_message %}
            <div class="error">{{ error_message }}</div>
        {% endif %}

        <div class="thread-info">
            <div>タイトル：{{ thread_title or "（取得できませんでした）" }}</div>
            <div class="thread-url">URL：{{ thread_url }}</div>
            <div>
                カテゴリ：<strong>{{ board_category_label or '（未指定）' }}</strong><br>
                板：<strong>{{ board_label or '（未指定）' }}</strong>
            </div>
            <div>
                タイトルキーワード：<strong>{{ title_keyword or '（未指定）' }}</strong><br>
                本文キーワード：<strong>{{ post_keyword or '（未指定）' }}</strong>
            </div>

            {% if store_title %}
            <div class="store-search" data-store-title="{{ store_title }}">
                <span class="store-search-label">店舗ページ検索：</span>
                <a href="#" class="btn-mini store-search-link" data-site="city">シティヘブン</a>
                <a href="#" class="btn-mini store-search-link" data-site="dto">デリヘルタウン</a>
                <a href="#" class="btn-mini store-search-link" data-site="google">Google</a>
            </div>
            {% endif %}
        </div>
    </section>

    <section class="card">
        <h2>別キーワードで再検索</h2>

        <form method="post" action="/thread_search/posts">
            <input type="hidden" name="selected_thread" value="{{ thread_url|e }}">
            <input type="hidden" name="area" value="{{ area }}">
            <input type="hidden" name="period" value="{{ period }}">
            <input type="hidden" name="board_category" value="{{ board_category }}">
            <input type="hidden" name="board_id" value="{{ board_id }}">

            <div class="form-row">
                <label for="post_keyword_bottom">本文キーワード：</label>
                <input type="text" id="post_keyword_bottom" name="post_keyword" value="{{ post_keyword|e }}">
                <button type="submit" class="btn-primary">このスレで再検索</button>
            </div>

            <div class="form-row">
                <label for="title_keyword_bottom">（メモ用）タイトル検索ワード：</label>
                <input type="text" id="title_keyword_bottom" name="title_keyword" value="{{ title_keyword|e }}">
            </div>
        </form>

        <h2 style="margin-top:12px;">前後スレで再検索</h2>

        <div class="thread-pn-box">
            <form method="post" action="/thread_search/posts" class="thread-prev-next">
                <input type="hidden" name="area" value="{{ area }}">
                <input type="hidden" name="period" value="{{ period }}">
                <input type="hidden" name="post_keyword" value="{{ post_keyword|e }}">
                <input type="hidden" name="title_keyword" value="{{ title_keyword|e }}">
                <input type="hidden" name="selected_thread" value="{{ prev_thread_url or '' }}">
                <input type="hidden" name="board_category" value="{{ board_category }}">
                <input type="hidden" name="board_id" value="{{ board_id }}">

                <button type="submit" class="btn-secondary" {% if not prev_thread_url %}disabled{% endif %}>
                    前スレで再検索
                </button>
                <span class="thread-url">
                    {% if prev_thread_url %}{{ prev_thread_url }}{% else %}前スレが見つかりません。{% endif %}
                </span>
            </form>

            <form method="post" action="/thread_search/posts" class="thread-prev-next">
                <input type="hidden" name="area" value="{{ area }}">
                <input type="hidden" name="period" value="{{ period }}">
                <input type="hidden" name="post_keyword" value="{{ post_keyword|e }}">
                <input type="hidden" name="title_keyword" value="{{ title_keyword|e }}">
                <input type="hidden" name="selected_thread" value="{{ next_thread_url or '' }}">
                <input type="hidden" name="board_category" value="{{ board_category }}">
                <input type="hidden" name="board_id" value="{{ board_id }}">

                <button type="submit" class="btn-secondary" {% if not next_thread_url %}disabled{% endif %}>
                    次スレで再検索
                </button>
                <span class="thread-url">
                    {% if next_thread_url %}{{ next_thread_url }}{% else %}次スレが見つかりません。{% endif %}
                </span>
            </form>
        </div>

        {% if not error_message %}
        <div class="thread-save">
            <form method="post" action="/thread_search/save">
              <input type="hidden" name="thread_url" value="{{ thread_url|e }}">
              <button type="submit" class="btn-secondary">このスレを保存</button>
            </form>
        </div>
        {% endif %}
    </section>

    <section class="card">
        {% if entries and not error_message %}
            <h2>ヒットしたレス（{{ entries|length }}件）</h2>

            {% for item in entries %}
                {% set post = item.root %}
                <div class="result">
                    {% if store_title %}
                    <div class="name-store-search" data-store-title="{{ store_title }}">
                        <span class="name-store-search-label">名前で店舗ページ検索：</span>
                        <input type="text" name="name_keyword" placeholder="例：みかん">
                        <button type="button" class="btn-mini name-search-btn" data-site="city">シティヘブン</button>
                        <button type="button" class="btn-mini name-search-btn" data-site="dto">デリヘルタウン</button>
                        <button type="button" class="btn-mini name-search-btn" data-site="google">Google</button>
                    </div>
                    {% endif %}

                    <div class="result-id">
                        {% if post.post_no %}レス #{{ post.post_no }}{% else %}レス番号不明{% endif %}
                        {% if post.posted_at %}／ {{ post.posted_at }}{% endif %}
                    </div>

                    <div class="result-url">
                        URL：{{ thread_url }}{% if post.post_no %}（レス #{{ post.post_no }}）{% endif %}
                    </div>

                    <div class="result-text">{{ highlight(post.body, post_keyword) }}</div>

                    {% if item.anchor_targets %}
                        <div class="section-title-small">このレスが参照しているレス</div>
                        {% for a in item.anchor_targets %}
                            <div class="anchor-item">
                                <div class="anchor-meta">
                                    {% if a.post_no %}#{{ a.post_no }}{% else %}レス番号不明{% endif %}
                                    {% if a.posted_at %}／ {{ a.posted_at }}{% endif %}
                                </div>
                                <div class="anchor-body">{{ highlight_with_links(a.body, post_keyword, thread_url) }}</div>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <div class="section-title-small">このレスへの返信ツリー</div>
                    {% if item.tree %}
                        {% for node in item.tree %}
                            <div class="tree-item" style="margin-left: {{ node.depth * 20 }}px;">
                                <div class="tree-meta">
                                    {% if node.post.post_no %}#{{ node.post.post_no }}{% else %}レス番号不明{% endif %}
                                    {% if node.post.posted_at %}／ {{ node.post.posted_at }}{% endif %}
                                </div>
                                <div class="tree-body">{{ highlight(node.post.body, post_keyword) }}</div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-result">このレスへの返信（アンカー）は見つかりませんでした。</p>
                    {% endif %}

                    {% if item.context %}
                        <div class="section-title-small">このレスの前後（コンテキスト）</div>
                        {% for c in item.context %}
                            <div class="context-line {% if c.post_no and post.post_no and c.post_no == post.post_no %}context-line-root{% endif %}">
                                {% if c.post_no %}#{{ c.post_no }}{% else %}レス番号不明{% endif %}
                                {% if c.posted_at %}／ {{ c.posted_at }}{% endif %}
                                ：{{ highlight_with_links(c.body|replace('\n', ' '), post_keyword, thread_url) }}
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            {% endfor %}
        {% elif not error_message %}
            <p class="no-result">指定したキーワードを含むレスは見つかりませんでした。</p>
        {% endif %}
    </section>
</main>

<div id="anchorPreviewTooltip" class="anchor-preview-tooltip" aria-hidden="true"></div>

<script>
function normalizeStoreTitle(raw) {
    let s = (raw || "").trim();
    if (!s) return s;

    s = s.replace(/\s*\d+\s*$/g, "");
    s = s.replace(/[\s\u2460-\u2473\u24EA\u3251-\u325F\u32B1-\u32BF]+$/gu, "");

    try {
        s = s.replace(/[\s\p{Extended_Pictographic}\uFE0F\u200D]+$/gu, "");
    } catch (e) {}

    return s.trim();
}

document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".store-search").forEach(function(box) {
        const store = normalizeStoreTitle((box.dataset.storeTitle || "").trim());
        if (!store) return;

        box.querySelectorAll(".store-search-link[data-site]").forEach(function(a) {
            a.addEventListener("click", function(e) {
                e.preventDefault();
                const site = a.getAttribute("data-site");
                let query = "";
                if (site === "city") query = "site:cityheaven.net " + store;
                else if (site === "dto") query = "site:dto.jp " + store;
                else query = store;

                window.open("https://www.google.com/search?q=" + encodeURIComponent(query), "_blank", "noopener");
            });
        });
    });

    document.querySelectorAll(".name-store-search").forEach(function(box) {
        const store = normalizeStoreTitle((box.dataset.storeTitle || "").trim());
        const input = box.querySelector('input[name="name_keyword"]');
        if (!input || !store) return;

        box.querySelectorAll(".name-search-btn[data-site]").forEach(function(btn) {
            btn.addEventListener("click", function() {
                const name = (input.value || "").trim();
                if (!name) {
                    alert("名前を入力してください。");
                    return;
                }

                const site = btn.getAttribute("data-site");
                let query = "";
                if (site === "city") query = "site:cityheaven.net " + store + " " + name;
                else if (site === "dto") query = "site:dto.jp " + store + " " + name;
                else query = store + " " + name;

                window.open("https://www.google.com/search?q=" + encodeURIComponent(query), "_blank", "noopener");
            });
        });
    });
});

document.addEventListener("DOMContentLoaded", function() {
    const tooltip = document.getElementById("anchorPreviewTooltip");
    const cache = new Map();
    let activeKey = null;
    let aborter = null;
    let lastTouchKey = null;

    function escapeHtml(s) {
        return (s || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    function setTooltipHtml(html) {
        tooltip.innerHTML = html;
    }

    function showTooltipAt(x, y) {
        const pad = 12;
        const w = tooltip.offsetWidth || 320;
        const h = tooltip.offsetHeight || 120;
        const vw = window.innerWidth;
        const vh = window.innerHeight;

        let left = x + pad;
        let top = y + pad;

        if (left + w + pad > vw) left = Math.max(pad, x - w - pad);
        if (top + h + pad > vh) top = Math.max(pad, y - h - pad);

        tooltip.style.left = left + "px";
        tooltip.style.top = top + "px";
        tooltip.setAttribute("aria-hidden", "false");
    }

    function hideTooltip() {
        tooltip.setAttribute("aria-hidden", "true");
        activeKey = null;
        if (aborter) {
            aborter.abort();
            aborter = null;
        }
    }

    function parseAnchorNo(a) {
        const dataNo = a.getAttribute("data-anchor-no");
        if (dataNo && /^\d+$/.test(dataNo)) return dataNo;

        const t = (a.textContent || "").trim();
        const m = t.match(/^>>\s*(\d+)$/);
        if (m) return m[1];

        return null;
    }

    async function fetchPreview(threadUrl, no) {
        const key = threadUrl + "#" + no;
        if (cache.has(key)) return cache.get(key);

        if (aborter) aborter.abort();
        aborter = new AbortController();

        const url = "/api/post_preview?thread_url=" + encodeURIComponent(threadUrl) + "&post_no=" + encodeURIComponent(no);
        const res = await fetch(url, { signal: aborter.signal, headers: { "Accept": "application/json" }});
        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        cache.set(key, data);
        return data;
    }

    function renderLoading(no) {
        setTooltipHtml(
            '<div class="tooltip-meta">>>' + escapeHtml(no) + '</div>' +
            '<div class="tooltip-loading">読み込み中…</div>'
        );
    }

    function renderError(no) {
        setTooltipHtml(
            '<div class="tooltip-meta">>>' + escapeHtml(no) + '</div>' +
            '<div class="tooltip-error">取得できませんでした（保存されていない/DBに存在しない可能性）</div>'
        );
    }

    function renderData(no, data) {
        const posted = data && data.posted_at ? (" ／ " + escapeHtml(data.posted_at)) : "";
        const body = data && data.body ? escapeHtml(data.body) : "";
        setTooltipHtml(
            '<div class="tooltip-meta">>>' + escapeHtml(no) + posted + '</div>' +
            '<div class="tooltip-body">' + body + '</div>'
        );
    }

    function attachToAnchor(a) {
        const no = parseAnchorNo(a);
        if (!no) return;

        a.classList.add("anchor-link");
        if (!a.getAttribute("data-anchor-no")) a.setAttribute("data-anchor-no", no);

        a.addEventListener("mouseenter", async function(e) {
            const threadUrl = document.querySelector("main[data-thread-url]")?.getAttribute("data-thread-url") || "";
            if (!threadUrl) return;

            const key = threadUrl + "#" + no;
            activeKey = key;

            renderLoading(no);
            showTooltipAt(e.clientX, e.clientY);

            try {
                const data = await fetchPreview(threadUrl, no);
                if (activeKey !== key) return;
                renderData(no, data);
                showTooltipAt(e.clientX, e.clientY);
            } catch (err) {
                if (activeKey !== key) return;
                renderError(no);
                showTooltipAt(e.clientX, e.clientY);
            }
        });

        a.addEventListener("mousemove", function(e) {
            if (tooltip.getAttribute("aria-hidden") === "false") {
                showTooltipAt(e.clientX, e.clientY);
            }
        });

        a.addEventListener("mouseleave", function() {
            hideTooltip();
        });

        a.addEventListener("click", async function(e) {
            if (!("ontouchstart" in window) && navigator.maxTouchPoints === 0) return;

            const threadUrl = document.querySelector("main[data-thread-url]")?.getAttribute("data-thread-url") || "";
            if (!threadUrl) return;

            const key = threadUrl + "#" + no;
            if (lastTouchKey !== key) {
                e.preventDefault();
                lastTouchKey = key;

                renderLoading(no);
                showTooltipAt(window.innerWidth / 2, window.innerHeight / 2);

                try {
                    const data = await fetchPreview(threadUrl, no);
                    renderData(no, data);
                } catch (err) {
                    renderError(no);
                }

                setTimeout(function() {
                    if (lastTouchKey === key) lastTouchKey = null;
                    hideTooltip();
                }, 3000);
            } else {
                lastTouchKey = null;
            }
        });
    }

    document.querySelectorAll("a").forEach(function(a) {
        const t = (a.textContent || "").trim();
        if (a.classList.contains("anchor-link") || /^>>\s*\d+$/.test(t) || a.getAttribute("data-anchor-no")) {
            attachToAnchor(a);
        }
    });

    document.addEventListener("click", function(e) {
        if (tooltip.getAttribute("aria-hidden") === "false") {
            if (!tooltip.contains(e.target)) hideTooltip();
        }
    });
});

/* ハンバーガーメニュー開閉 */
document.addEventListener("DOMContentLoaded", function() {
    const btn = document.getElementById("hamburgerButton");
    const overlay = document.getElementById("quickMenuOverlay");
    if (!btn || !overlay) return;

    function openMenu() {
        overlay.classList.add("open");
        btn.classList.add("open");
        document.body.classList.add("quick-menu-open");
    }

    function closeMenu() {
        overlay.classList.remove("open");
        btn.classList.remove("open");
        document.body.classList.remove("quick-menu-open");
    }

    btn.addEventListener("click", function() {
        if (overlay.classList.contains("open")) closeMenu();
        else openMenu();
    });

    overlay.addEventListener("click", function(e) {
        if (e.target === overlay) closeMenu();
    });

    const closeBtn = overlay.querySelector(".quick-menu-close");
    if (closeBtn) closeBtn.addEventListener("click", closeMenu);

    document.addEventListener("keydown", function(e) {
        if (e.key === "Escape" && overlay.classList.contains("open")) closeMenu();
    });
});
</script>

</body>
</html>
