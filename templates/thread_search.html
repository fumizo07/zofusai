<!-- templates/thread_search.html -->
{% set page_title_suffix = "外部検索" %}
{% set body_class = "page-thread-search" %}
{% set active_page = "thread_search" %}
{% include "_header.html" %}

{# ★この画面の「正しい戻り先」（条件一式 + no_log=1） #}
{% set _back_url = back_url
    or ("/thread_search?area=" ~ (current_area|urlencode)
        ~ "&period=" ~ (current_period|urlencode)
        ~ "&board_category=" ~ (current_board_category|urlencode)
        ~ "&board_id=" ~ (current_board_id|urlencode)
        ~ "&keyword=" ~ (keyword|urlencode)
        ~ "&no_log=1")
%}

<main>
    <!-- 検索フォーム -->
    <section class="card">
        <form method="get" action="/thread_search">
            <div class="form-row">
                <label for="area">地域：</label>
                <select name="area" id="area">
                    {% for a in area_options %}
                        <option value="{{ a.code }}"
                                {% if a.code == current_area %}selected{% endif %}>
                            {{ a.label }}
                        </option>
                    {% endfor %}
                </select>

                <label for="period">期間設定：</label>
                <select name="period" id="period">
                    {% for p in period_options %}
                        <option value="{{ p.id }}"
                                {% if p.id == current_period %}selected{% endif %}>
                            {{ p.label }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-row">
                <label for="board_category">カテゴリ：</label>
                <select name="board_category" id="board_category">
                    {% for c in board_category_options %}
                        <option value="{{ c.id }}"
                                {% if c.id == current_board_category %}selected{% endif %}>
                            {{ c.label }}
                        </option>
                    {% endfor %}
                </select>

                <label for="board_id">板：</label>
                <select name="board_id" id="board_id">
                    <option value="">（カテゴリを先に選択）</option>
                </select>
            </div>

            <div class="form-row">
                <label for="keyword">タイトル検索：</label>
                <input type="text" id="keyword" name="keyword" value="{{ keyword|e }}" />

                <button type="submit" class="btn-primary">
                    外部スレッド検索
                </button>
            </div>

            {% if error_message %}
                <div class="error">{{ error_message }}</div>
            {% endif %}
        </form>
    </section>

    {% if ranking_board %}
    {% include "_ranking.html" %}
    {% endif %}

    {% if recent_external_searches %}
    <section class="card">
        <div class="section-title">最近の外部検索（最大15件）</div>
        <ul class="history-list">
            {% for e in recent_external_searches %}
                <li>
                    <a href="/thread_search?area={{ e.area|urlencode }}&period={{ e.period|urlencode }}&board_category={{ e.board_category|urlencode }}&board_id={{ e.board_id|urlencode }}&keyword={{ e.keyword|urlencode }}">
                        [{{ e.period_label }}]
                        {% if e.board_category_label %}{{ e.board_category_label }}{% endif %}
                        {% if e.board_label %} / {{ e.board_label }}{% endif %}
                        ：「{{ e.keyword }}」
                    </a>
                    <form method="post" action="/thread_search/history/delete" style="display:inline; margin-left:4px;">
                        <input type="hidden" name="key" value="{{ e.key }}">
                        <button type="submit" class="btn-secondary btn-mini">削除</button>
                    </form>
                </li>
            {% endfor %}
        </ul>
        <form method="post" action="/thread_search/history/clear" style="margin-top:6px;">
            <button type="submit" class="btn-secondary btn-mini">履歴を全て削除</button>
        </form>
    </section>
    {% endif %}

    <!-- 検索結果（スレ一覧） -->
    <section class="card">
        <div class="section-title">スレッド一覧</div>

        {% if results %}
            <div class="results-summary">
                {{ keyword }} の検索結果（{{ results|length }}件）
            </div>

            <div class="thread-actions-inline">
                <form id="save-thread-form-top" method="post" action="/thread_search/save">
                    <input type="hidden" name="thread_url" id="save-thread-url-top" value="">
                    <input type="hidden" name="back_url" value="{{ _back_url|e }}">
                    <button type="submit" class="btn-secondary">
                        このスレを保存
                    </button>
                </form>
            </div>

            <!-- スレッド内検索フォーム（ラジオ選択＋本文キーワード） -->
            <form id="thread-post-search-form" method="post" action="/thread_search/posts">
                <input type="hidden" name="area" value="{{ current_area|e }}">
                <input type="hidden" name="period" value="{{ current_period|e }}">
                <input type="hidden" name="board_category" value="{{ current_board_category|e }}">
                <input type="hidden" name="board_id" value="{{ current_board_id|e }}">
                <input type="hidden" name="back_url" value="{{ _back_url|e }}">

                {% for t in results %}
                    <div class="thread-item">
                        <label style="display:flex; gap:8px; align-items:flex-start; cursor:pointer;">
                            <input type="radio"
                                   name="selected_thread"
                                   value="{{ t.url|e }}"
                                   {% if loop.first %}checked{% endif %}
                                   style="margin-top:4px;">
                            <div style="flex:1 1 auto;">
                                <div class="thread-title">
                                    {{ t.title }}
                                    　<a
                                        class="btn-sm primary"
                                        href="/thread_search/showall?url={{ t.url|urlencode }}&area={{ current_area|urlencode }}&period={{ current_period|urlencode }}&board_category={{ current_board_category|urlencode }}&board_id={{ current_board_id|urlencode }}&title_keyword={{ keyword|urlencode }}&back_url={{ _back_url|urlencode }}"
                                        target="_blank">
                                        全レス表示
                                    </a>
                                </div>
                                <div class="thread-meta">
                                    最新レス：{{ t.last_post_at_str }}<br>
                                    スレURL：{{ t.url }}
                                </div>
                            </div>
                        </label>
                    </div>
                {% endfor %}

                <div class="section-title" style="margin-top: 12px;">
                    選んだスレ内でキーワード検索
                </div>
                <div class="form-row">
                    <label for="post_keyword">本文キーワード：</label>
                    <input type="text" id="post_keyword" name="post_keyword" value="" />
                    <button type="submit" class="btn-primary">
                        スレッド内検索
                    </button>
                </div>
                <div class="form-row">
                    <label for="title_keyword">（メモ用）タイトル検索ワード：</label>
                    <input type="text" id="title_keyword" name="title_keyword" value="{{ keyword|e }}" />
                </div>
            </form>

            <!-- 選択中スレを保存するフォーム（別フォームでネストを避ける） -->
            <div class="thread-actions-inline">
                <form id="save-thread-form-bottom" method="post" action="/thread_search/save">
                    <input type="hidden" name="thread_url" id="save-thread-url-bottom" value="">
                    <input type="hidden" name="back_url" value="{{ _back_url|e }}">
                    <button type="submit" class="btn-secondary">
                        このスレを保存
                    </button>
                </form>
            </div>
        {% else %}
            <p style="font-size: 14px; color: #6b7280;">
                まだ検索結果がありません。条件を指定して「外部スレッド検索」を実行してください。
            </p>
        {% endif %}
    </section>
</main>

<script>
(function() {
    const BOARD_MASTER = {{ board_master_json|safe }};
    const boardCategorySelect = document.getElementById("board_category");
    const boardSelect = document.getElementById("board_id");
    const areaSelect = document.getElementById("area");

    const currentBoardCategory = "{{ current_board_category|default('', true) }}";
    const currentBoardId = "{{ current_board_id|default('', true) }}";

    const AREA_PREFIX_MAP = {
        "1":  ["北海道", "札幌", "函館"],
        "18": ["滋賀", "京都", "兵庫"],
        "7":  ["大阪"],
        "5":  ["愛知"],
        "3":  ["東京", "西東京", "吉原"],
        "10": ["福岡"]
    };

    function filterBoardsByArea(categoryId, areaCode) {
        let boards = BOARD_MASTER[categoryId] || [];

        if (categoryId === "122") {
            return boards;
        }
        if (!areaCode) return [];

        const prefixes = AREA_PREFIX_MAP[areaCode] || [];
        if (!prefixes.length) return [];

        return boards.filter(b => {
            const label = b.label || "";
            return prefixes.some(prefix => label.startsWith(prefix));
        });
    }

    function populateBoards(categoryId, selectedId) {
        if (!boardSelect) return;

        while (boardSelect.firstChild) boardSelect.removeChild(boardSelect.firstChild);

        if (!categoryId) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "（カテゴリを先に選択）";
            boardSelect.appendChild(opt);
            boardSelect.disabled = true;
            return;
        }

        const areaCode = areaSelect ? areaSelect.value : "";
        const boards = filterBoardsByArea(categoryId, areaCode);

        if (!boards.length) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "（この地域×カテゴリの板マスタ未設定）";
            boardSelect.appendChild(opt);
            boardSelect.disabled = true;
            return;
        }

        const firstOpt = document.createElement("option");
        firstOpt.value = "";
        firstOpt.textContent = "（板を選択）";
        boardSelect.appendChild(firstOpt);

        boards.forEach(b => {
            const opt = document.createElement("option");
            opt.value = b.id;
            opt.textContent = b.label;
            boardSelect.appendChild(opt);
        });

        boardSelect.disabled = false;

        if (selectedId) boardSelect.value = selectedId;
    }

    document.addEventListener("DOMContentLoaded", function() {
        if (!boardCategorySelect || !boardSelect) return;

        const initialCategory = currentBoardCategory || boardCategorySelect.value || "";
        populateBoards(initialCategory, currentBoardId || "");

        boardCategorySelect.addEventListener("change", function() {
            populateBoards(this.value, "");
        });

        if (areaSelect) {
            areaSelect.addEventListener("change", function() {
                const cat = boardCategorySelect.value || "";
                populateBoards(cat, "");
            });
        }
    });
})();

// 「このスレを保存」用：選択中ラジオのURLを hidden に入れる（NodeListバグ修正）
document.addEventListener("DOMContentLoaded", function() {
    const radios = document.querySelectorAll('input[name="selected_thread"]');
    const hiddenTop = document.getElementById("save-thread-url-top");
    const hiddenBottom = document.getElementById("save-thread-url-bottom");
    const formTop = document.getElementById("save-thread-form-top");
    const formBottom = document.getElementById("save-thread-form-bottom");

    function getCheckedValue() {
        for (const r of radios) {
            if (r.checked) return r.value || "";
        }
        return "";
    }

    function updateHidden() {
        const v = getCheckedValue();
        if (hiddenTop) hiddenTop.value = v;
        if (hiddenBottom) hiddenBottom.value = v;
    }

    if (radios.length) {
        updateHidden();
        radios.forEach(r => r.addEventListener("change", updateHidden));
    }

    function guardSubmit(e) {
        updateHidden();
        const v = getCheckedValue();
        if (!v) {
            e.preventDefault();
            alert("保存するスレッドを選択してください。");
        }
    }

    if (formTop) formTop.addEventListener("submit", guardSubmit);
    if (formBottom) formBottom.addEventListener("submit", guardSubmit);
});
</script>

{% include "_footer.html" %}
