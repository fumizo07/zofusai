{% set page_title_suffix = "スレッド一覧" %}
{% set body_class = "page-threads" %}
{% set active_page = "threads" %}
{% include "_header.html" %}

<main>
    <!-- 左：スレ一覧 -->
    <section class="card">
        <h2>取り込み済みスレッド一覧</h2>
        <small class="muted">最新レス日時の新しい順に表示しています。</small>

        {% if info_message %}
            <p class="muted" style="margin-top:6px;">{{ info_message }}</p>
        {% endif %}

        {% if threads %}
        <div style="margin-top:8px; max-height: 70vh; overflow:auto;">
            <table class="threads-table">
                <thead>
                <tr>
                    <th>タイトル / URL</th>
                    <th>ラベル</th>
                    <th>最終レス</th>
                    <th>レス数</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                {% for t in threads %}
                    <tr>
                        <td>
                            <div class="thread-title">{{ t.thread_title }}</div>
                            <div class="thread-url">{{ t.thread_url }}</div>
                        </td>
                        <td>
                            <form class="label-form" method="post" action="/threads/label">
                                <input type="hidden" name="thread_url" value="{{ t.thread_url }}">
                                <input class="label-input" type="text" name="label" value="{{ t.label }}">
                                <button type="submit" class="btn-sm primary">保存</button>
                            </form>
                        </td>
                        <td class="thread-meta">
                            {% if t.last_posted_at %}
                                {{ t.last_posted_at }}
                            {% else %}
                                -
                            {% endif %}
                            <br>
                            No. {{ t.max_no or "-" }}
                        </td>
                        <td class="thread-meta">
                            {{ t.post_count }}
                        </td>
                        <td>
                            <!-- このスレだけ検索（thread_filter に URL を突っ込む） -->
                            <a class="btn-sm" href="/?thread_filter={{ t.thread_url | urlencode }}">このスレで検索</a>

                            <!-- このスレだけ再取得 -->
                            <form method="post" action="/admin/refetch" style="display:inline;">
                                <input type="hidden" name="url" value="{{ t.thread_url }}">
                                <button type="submit" class="btn-sm">再取得</button>
                            </form>

                            <!-- このスレの次スレを取得 -->
                            <form method="post" action="/admin/fetch_next" style="display:inline;">
                                <input type="hidden" name="url" value="{{ t.thread_url }}">
                                <button type="submit" class="btn-sm">次スレ取得</button>
                            </form>

                            <!-- このスレだけ削除 -->
                            <form method="post" action="/admin/delete_thread" style="display:inline;" onsubmit="return confirm('このスレのデータを削除しますか？');">
                                <input type="hidden" name="url" value="{{ t.thread_url }}">
                                <button type="submit" class="btn-sm danger">削除</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
            <p class="muted" style="margin-top:8px;">まだスレッドが取り込まれていません。</p>
        {% endif %}
    </section>

    <!-- 右：タグ一覧 / 最近の検索条件 -->
    <section style="display:flex; flex-direction:column; gap:12px;">
        <div class="card">
            <h2>最近の検索条件</h2>
            {% if recent_searches %}
                <div class="recent-searches">
                    {% for s in recent_searches %}
                        {% set p = s.params %}
                        <a class="recent-item" href="{{ s.url }}">
                            <strong>{{ p.q or "（キーワードなし）" }}</strong>
                            <small>
                                スレ: {{ p.thread_filter or "指定なし" }} /
                                タグ: {{ p.tags or "指定なし" }} /
                                モード: {{ p.tag_mode }}
                            </small>
                        </a>
                    {% endfor %}
                </div>
            {% else %}
                <p class="muted">まだ検索履歴がありません。</p>
            {% endif %}
        </div>

        <div class="card">
            <h2>タグ一覧（よく使う順）</h2>
            {% if popular_tags %}
                <div class="tag-list">
                    {% for tag in popular_tags %}
                        <a class="tag-pill"
                           href="/?q=&thread_filter=&tags={{ tag.name | urlencode }}&tag_mode=or">
                            {{ tag.name }}<span class="count">×{{ tag.count }}</span>
                        </a>
                    {% endfor %}
                </div>
            {% else %}
                <p class="muted">まだタグはありません。</p>
            {% endif %}
        </div>
    </section>
</main>
</body>
</html>
