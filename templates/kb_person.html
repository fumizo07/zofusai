{# 012 #}
{% set page_title_suffix = "KB - 人物" %}
{% set body_class = "page-kb" %}
{% set active_page = "kb" %}
{% set store_kw = (store.name[:4] if store and store.name else "") %}
{% set post_kw  = (person.name or "") %}
{% include "_header.html" %}

<main>
  <section class="card">
    <div class="section-title">人物</div>

    <p class="back-link">
      <a href="/kb/store/{{ store.id if store else '' }}">店舗に戻る</a>
      &nbsp;|&nbsp;
      <a href="/kb">KBトップに戻る</a>
      &nbsp;|&nbsp;
      <a href="/kb/person/{{ person.id }}/external_search" target="_blank">外部検索で調べる</a>
    </p>

    {% if dup_candidates %}
      <div class="result">
        <div class="result-id">⚠️ 似ている人物が既に登録されている可能性があります</div>
        <div class="muted">
          {% for d in dup_candidates %}
            <a href="/kb/person/{{ d.id }}">{{ d.name }}</a>{% if not loop.last %} / {% endif %}
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <div class="thread-info">
      <div>地域：<strong>{{ region.name if region else "（不明）" }}</strong></div>
      <div>店舗：<strong>{{ store.name if store else "（不明）" }}</strong></div>
      <div>
        人物：<strong>{{ person.name }}</strong>
        {%- if person.services -%}／{{ person.services }}{%- endif -%}
        {% if person.age %}／{{ person.age }}歳{% endif %}
        {% if person.height_cm %}／T{{ person.height_cm }}{% endif %}
        {% if person.bust_cm %}・B{{ person.bust_cm }}{% if person.cup %}({{ person.cup }}){% endif %}{% endif %}
        {% if person.waist_cm %}・W{{ person.waist_cm }}{% endif %}
        {% if person.hip_cm %}・H{{ person.hip_cm }}{% endif %}
      </div>

      {% if person.url %}
        <div>URL：<a href="{{ person.url|e }}" target="_blank" rel="noopener noreferrer">{{ person.url }}</a></div>
      {% endif %}

      <div class="muted">
        外部検索（Google）：
        {% if google_all_url %}<a href="{{ google_all_url|e }}" target="_blank" rel="noopener noreferrer">全体</a>{% endif %}
        {% if google_cityheaven_url %} / <a href="{{ google_cityheaven_url|e }}" target="_blank" rel="noopener noreferrer">cityheaven</a>{% endif %}
        {% if google_dto_url %} / <a href="{{ google_dto_url|e }}" target="_blank" rel="noopener noreferrer">dto</a>{% endif %}
      </div>

      <div class="muted">
        写メ日記（検索）：
        {% if google_all_diary_url %}<a href="{{ google_all_diary_url|e }}" target="_blank" rel="noopener noreferrer">全体</a>{% endif %}
        {% if google_cityheaven_diary_url %} / <a href="{{ google_cityheaven_diary_url|e }}" target="_blank" rel="noopener noreferrer">cityheaven</a>{% endif %}
        {% if google_dto_diary_url %} / <a href="{{ google_dto_diary_url|e }}" target="_blank" rel="noopener noreferrer">dto</a>{% endif %}
      </div>

      {% if person.image_urls %}
        <div>画像：</div>
        <div class="kb-person-images">
          {% for u in person.image_urls %}
            {% if u %}
              <a href="{{ u|e }}" target="_blank" rel="noopener noreferrer">
                <img class="kb-person-image"
                     src="{{ u|e }}"
                     alt="image"
                     loading="lazy"
                     referrerpolicy="no-referrer">
              </a>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      {% if rating_avg %}
        <div class="muted">平均評価：{{ "%.2f"|format(rating_avg) }}</div>
      {% endif %}
      {% if amount_avg_yen is not none %}
        <div class="muted">平均金額：{{ "{:,}".format(amount_avg_yen) }}円</div>
      {% endif %}
    </div>
  </section>

  <section class="card">
    <h2>人物情報（編集）</h2>

    <form method="post" action="/kb/person/{{ person.id }}/update">
      <div class="kb-profile-grid">

        <div class="inner-flex-box">
          <div class="kb-grid-label">名前：</div>
          <div class="kb-grid-input"><input type="text" name="name" value="{{ person.name }}"></div>
        </div>

        <div class="inner-flex-box">
          <div class="kb-grid-label">年齢：</div>
          <div class="kb-grid-input"><input class="kb-input-sm" type="number" name="age" value="{{ person.age or '' }}" placeholder="例：24" min="18" max="99"></div>
        </div>

        <div class="inner-flex-box">
          <div class="kb-grid-label">身長：</div>
          <div class="kb-grid-input"><input class="kb-input-sm" type="number" name="height_cm" value="{{ person.height_cm or '' }}" placeholder="例：160" min="100" max="200"></div>
        </div>

        <div class="inner-flex-box">
          <div class="kb-grid-label">カップ：</div>
          <div class="kb-grid-input">
            <select class="kb-input-sm kb-select" name="cup">
              <option value="" {% if not person.cup %}selected{% endif %}>（未設定）</option>
              {% for c in "ABCDEFGHIJKLMNOPQRSTUVWXYZ" %}
                <option value="{{ c }}" {% if person.cup == c %}selected{% endif %}>{{ c }}カップ</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="inner-flex-box">
          <div class="kb-grid-label">3サイズ：</div>
          <div class="kb-sizes">
            <input class="kb-input-xs" type="number" name="bust_cm" value="{{ person.bust_cm or '' }}" placeholder="B" min="0" max="200">
            <input class="kb-input-xs" type="number" name="waist_cm" value="{{ person.waist_cm or '' }}" placeholder="W" min="0" max="200">
            <input class="kb-input-xs" type="number" name="hip_cm" value="{{ person.hip_cm or '' }}" placeholder="H" min="0" max="200">
          </div>
        </div>

        <div class="inner-flex-box">
          <div class="kb-grid-label">サービス：</div>
          <div class="kb-grid-input"><input type="text" name="services" value="{{ person.services or '' }}" placeholder="例：○○, △△, ××（カンマ区切りで複数可）"></div>
        </div>

        <div class="inner-flex-box">
          <div class="kb-grid-label">タグ：</div>
          <div class="kb-grid-input"><input type="text" name="tags" value="{{ person.tags or '' }}" placeholder="カンマ区切り"></div>
        </div>

        <div class="inner-flex-box">
          <div class="kb-grid-label">URL：</div>
          <div class="kb-grid-input"><input type="text" name="url" value="{{ person.url or '' }}" placeholder="https://..."></div>
        </div>

        <div class="kb-grid-label">画像URL：</div>
        <div>
          <textarea name="image_urls_text" rows="6"
                    placeholder="1行に1つ、http(s)の直リンクURLを貼ってください（例：https://.../a.jpg）">{% if person.image_urls %}{{ person.image_urls|join('\n') }}{% endif %}</textarea>
          <div class="muted">※画像自体は保存せず、URLだけ保存します。表示はブラウザが外部から読み込みます。</div>
        </div>

        <div class="kb-grid-label">メモ：</div>
        <div><textarea name="memo" rows="15">{{ person.memo or '' }}</textarea></div>
      </div>

      <div class="form-row">
        <button type="submit" class="btn-primary">保存</button>
      </div>
    </form>

    <hr>

    <form method="post" action="/kb/person/{{ person.id }}/delete"
          onsubmit="return confirm('この人物と利用ログをすべて削除します。本当に削除しますか？');">
      <button type="submit" class="btn-secondary">この人物を削除</button>
    </form>
  </section>

  <!-- 以降（利用ログ追加・一覧）はあなたの元のまま -->
  {{ super() if false else "" }}
</main>

{% include "_footer.html" %}
