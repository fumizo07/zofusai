{# 011 #}
{% set page_title_suffix = "KB - 人物" %}
{% set body_class = "page-kb" %}
{% set active_page = "kb" %}
{% set store_kw = (store.name[:4] if store and store.name else "") %}
{% set post_kw  = (person.name or "") %}
{% include "_header.html" %}

<main>
  <section class="card">
    <div class="section-title">人物</div>

    <p class="back-link">
      <a href="/kb/store/{{ store.id if store else '' }}">店舗に戻る</a>
      &nbsp;|&nbsp;
      <a href="/kb">KBトップに戻る</a>
      &nbsp;|&nbsp;
      <a href="/kb/person/{{ person.id }}/external_search" target="_blank">外部検索で調べる</a>
    </p>

    <div class="thread-info">
      <div>地域：<strong>{{ region.name if region else "（不明）" }}</strong></div>
      <div>店舗：<strong>{{ store.name if store else "（不明）" }}</strong></div>
      <div>
        人物：<strong>{{ person.name }}</strong>
        {%- if person.services -%}／{{ person.services }}{%- endif -%}
        {% if person.age %}／{{ person.age }}歳{% endif %}
        {% if person.height_cm %}／T{{ person.height_cm }}{% endif %}
        {% if person.bust_cm %}・B{{ person.bust_cm }}{% if person.cup %}({{ person.cup }}){% endif %}{% endif %}
        {% if person.waist_cm %}・W{{ person.waist_cm }}{% endif %}
        {% if person.hip_cm %}・H{{ person.hip_cm }}{% endif %}
      </div>

      {% if person.url %}
        <div>URL：<a href="{{ person.url|e }}" target="_blank" rel="noopener noreferrer">{{ person.url }}</a></div>
      {% endif %}

      {% if person.image_urls %}
        <div>画像：</div>
        <div class="kb-person-images">
          {% for u in person.image_urls %}
            {% if u %}
              <a href="{{ u|e }}" target="_blank" rel="noopener noreferrer">
                <img class="kb-person-image"
                     src="{{ u|e }}"
                     alt="image"
                     loading="lazy"
                     referrerpolicy="no-referrer">
              </a>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      {% if rating_avg %}
        <div class="muted">平均評価：{{ "%.2f"|format(rating_avg) }}</div>
      {% endif %}
      {% if amount_avg_yen is not none %}
        <div class="muted">平均金額：{{ "{:,}".format(amount_avg_yen) }}円</div>
      {% endif %}
    </div>
  </section>

  <section class="card">
    <h2>人物情報（編集）</h2>

    <form method="post" action="/kb/person/{{ person.id }}/update">
      <div class="kb-profile-grid">

        <div class="inner-flex-box">
          <div class="kb-grid-label">名前：</div>
          <div class="kb-grid-input"><input type="text" name="name" value="{{ person.name }}"></div>
        </div>

        <div class="inner-flex-box">
          <div class="kb-grid-label">年齢：</div>
          <div class="kb-grid-input"><input class="kb-input-sm" type="number" name="age" value="{{ person.age or '' }}" placeholder="例：24" min="18" max="99"></div>
        </div>

        <div class="inner-flex-box">
          <div class="kb-grid-label">身長：</div>
          <div class="kb-grid-input"><input class="kb-input-sm" type="number" name="height_cm" value="{{ person.height_cm or '' }}" placeholder="例：160" min="100" max="200"></div>
        </div>

        <div class="inner-flex-box">
          <div class="kb-grid-label">カップ：</div>
          <div class="kb-grid-input">
            <select class="kb-input-sm kb-select" name="cup">
              <option value="" {% if not person.cup %}selected{% endif %}>（未設定）</option>
              {% for c in "ABCDEFGHIJKLMNOPQRSTUVWXYZ" %}
                <option value="{{ c }}" {% if person.cup == c %}selected{% endif %}>{{ c }}カップ</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="inner-flex-box">
          <div class="kb-grid-label">3サイズ：</div>
          <div class="kb-sizes">
            <input class="kb-input-xs" type="number" name="bust_cm" value="{{ person.bust_cm or '' }}" placeholder="B" min="0" max="200">
            <input class="kb-input-xs" type="number" name="waist_cm" value="{{ person.waist_cm or '' }}" placeholder="W" min="0" max="200">
            <input class="kb-input-xs" type="number" name="hip_cm" value="{{ person.hip_cm or '' }}" placeholder="H" min="0" max="200">
          </div>
        </div>

        <div class="inner-flex-box">
          <div class="kb-grid-label">サービス：</div>
          <div class="kb-grid-input"><input type="text" name="services" value="{{ person.services or '' }}" placeholder="例：○○, △△, ××（カンマ区切りで複数可）"></div>
        </div>

        <div class="inner-flex-box">
          <div class="kb-grid-label">タグ：</div>
          <div class="kb-grid-input"><input type="text" name="tags" value="{{ person.tags or '' }}" placeholder="カンマ区切り"></div>
        </div>

        <div class="inner-flex-box">
          <div class="kb-grid-label">URL：</div>
          <div class="kb-grid-input"><input type="text" name="url" value="{{ person.url or '' }}" placeholder="https://..."></div>
        </div>

        <div class="kb-grid-label">画像URL：</div>
        <div>
          <textarea name="image_urls_text" rows="6"
                    placeholder="1行に1つ、http(s)の直リンクURLを貼ってください（例：https://.../a.jpg）">{% if person.image_urls %}{{ person.image_urls|join('\n') }}{% endif %}</textarea>
          <div class="muted">※画像自体は保存せず、URLだけ保存します。表示はブラウザが外部から読み込みます。</div>
        </div>

        <div class="kb-grid-label">メモ：</div>
        <div><textarea name="memo" rows="15">{{ person.memo or '' }}</textarea></div>
      </div>

      <div class="form-row">
        <button type="submit" class="btn-primary">保存</button>
      </div>
    </form>

    <hr>

    <form method="post" action="/kb/person/{{ person.id }}/delete"
          onsubmit="return confirm('この人物と利用ログをすべて削除します。本当に削除しますか？');">
      <button type="submit" class="btn-secondary">この人物を削除</button>
    </form>
  </section>

  <section class="card">
    <h2>利用ログを追加</h2>

    <form method="post" action="/kb/person/{{ person.id }}/visit">
      <div class="form-row">
        <label>利用日：</label>
        <input type="date" name="visited_at">
      </div>

      <div class="form-row">
        <label>利用時間：</label>
        <div class="kb-times">
          <span class="muted">開始</span>
          <input type="time" name="start_time" step="60">
          <span class="muted">終了</span>
          <input type="time" name="end_time" step="60">
          <span class="muted">→</span>
          <span class="kb-duration" data-kb-duration-label></span>
          <input type="hidden" name="duration_min" value="">
        </div>
      </div>

      <div class="form-row">
        <label>評価：</label>
        <div data-star-rating class="kb-stars">
          <input type="hidden" name="rating" value="">
          <button type="button" class="kb-star" data-value="1">☆</button>
          <button type="button" class="kb-star" data-value="2">☆</button>
          <button type="button" class="kb-star" data-value="3">☆</button>
          <button type="button" class="kb-star" data-value="4">☆</button>
          <button type="button" class="kb-star" data-value="5">☆</button>
          <span class="muted" data-star-label></span>
        </div>
      </div>

      <div class="form-row">
        <label>メモ：</label>
        <textarea name="memo" rows="3"></textarea>
      </div>

      <div class="section-title-small">料金明細</div>

      <div class="kb-price-box" data-price-items>
        <input type="hidden" name="price_items_json" value="[]">

        <table class="kb-price-table">
          <thead>
            <tr>
              <th>項目</th>
              <th>金額</th>
              <th></th>
            </tr>
          </thead>
          <tbody data-price-items-body>
            <tr>
              <td><input type="text" data-price-label placeholder="例：オプション"></td>
              <td><input type="text" data-price-amount placeholder="例：3,000"></td>
              <td><button type="button" data-price-remove>削除</button></td>
            </tr>
          </tbody>
        </table>

        <div class="kb-price-actions kb-price-actions-gap">
          <button type="button" class="btn-secondary" data-price-add>明細行を追加</button>
          <span class="muted">合計：</span>
          <strong data-price-total>0</strong><span class="muted">円</span>
        </div>
      </div>

      <div class="form-row kb-visit-submit-row">
        <button type="submit" class="btn-primary">追加</button>
      </div>
    </form>
  </section>

  <section class="card">
    <h2>利用ログ一覧（{{ visits|length }}件）</h2>

    {% if visits %}
      {% for v in visits %}
        <div class="result">
          <div class="result-id">
            {% if v.visited_at %}
              {{ v.visited_at.strftime('%Y-%m-%d') }}
            {% else %}
              （日付未設定）
            {% endif %}

            {% if v.start_time is not none and v.end_time is not none %}
              <span class="muted">
                ／ {{ "%02d"|format(v.start_time // 60) }}:{{ "%02d"|format(v.start_time % 60) }}
                - {{ "%02d"|format(v.end_time // 60) }}:{{ "%02d"|format(v.end_time % 60) }}
              </span>
            {% endif %}

            {% if v.duration_min is not none %}
              <span class="muted">／ {{ v.duration_min }}分</span>
            {% endif %}
          </div>

          <div class="muted">
            {% if v.rating %}
              評価：
              {% for i in range(1, 6) %}
                {% if i <= v.rating %}★{% else %}☆{% endif %}
              {% endfor %}
            {% endif %}
            {% if v.total_yen is not none %} ／ 合計：{{ "{:,}".format(v.total_yen) }}円{% endif %}
          </div>

          {% if v.memo %}
            <div class="memo">メモ：{{ v.memo }}</div>
          {% endif %}

          {% if v.price_items %}
            <div class="tags">
              明細：
              {% for it in v.price_items %}
                {% if it.label %}{{ it.label }}{% else %}（項目）{% endif %}={{ "{:,}".format(it.amount or 0) }}円
                {% if not loop.last %} / {% endif %}
              {% endfor %}
            </div>
          {% endif %}

          <details class="kb-visit-edit">
            <summary class="muted">このログを編集</summary>

            <form method="post" action="/kb/visit/{{ v.id }}/update">
              <div class="form-row">
                <label>利用日：</label>
                <input type="date" name="visited_at"
                       value="{{ v.visited_at.strftime('%Y-%m-%d') if v.visited_at else '' }}">
              </div>

              <div class="form-row">
                <label>利用時間：</label>
                <div class="kb-times">
                  <span class="muted">開始</span>
                  <input type="time" name="start_time" step="60"
                         value="{% if v.start_time is not none %}{{ '%02d'|format(v.start_time // 60) }}:{{ '%02d'|format(v.start_time % 60) }}{% endif %}">
                  <span class="muted">終了</span>
                  <input type="time" name="end_time" step="60"
                         value="{% if v.end_time is not none %}{{ '%02d'|format(v.end_time // 60) }}:{{ '%02d'|format(v.end_time % 60) }}{% endif %}">
                  <span class="muted">→</span>
                  <span class="kb-duration" data-kb-duration-label></span>
                  <input type="hidden" name="duration_min" value="">
                </div>
              </div>

              <div class="form-row">
                <label>評価：</label>
                <div data-star-rating class="kb-stars">
                  <input type="hidden" name="rating" value="{{ v.rating or '' }}">
                  <button type="button" class="kb-star" data-value="1">☆</button>
                  <button type="button" class="kb-star" data-value="2">☆</button>
                  <button type="button" class="kb-star" data-value="3">☆</button>
                  <button type="button" class="kb-star" data-value="4">☆</button>
                  <button type="button" class="kb-star" data-value="5">☆</button>
                  <span class="muted" data-star-label></span>
                </div>
              </div>

              <div class="form-row">
                <label>メモ：</label>
                <textarea name="memo" rows="3">{{ v.memo or '' }}</textarea>
              </div>

              <div class="section-title-small">料金明細</div>

              <div class="kb-price-box" data-price-items>
                <input type="hidden" name="price_items_json" value="[]">

                <table class="kb-price-table">
                  <thead>
                    <tr>
                      <th>項目</th>
                      <th>金額</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody data-price-items-body>
                    {% if v.price_items %}
                      {% for it in v.price_items %}
                        <tr>
                          <td><input type="text" data-price-label value="{{ it.label or '' }}" placeholder="例：オプション"></td>
                          <td><input type="text" data-price-amount value="{{ it.amount or 0 }}" placeholder="例：3,000"></td>
                          <td><button type="button" data-price-remove>削除</button></td>
                        </tr>
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td><input type="text" data-price-label placeholder="例：オプション"></td>
                        <td><input type="text" data-price-amount placeholder="例：3,000"></td>
                        <td><button type="button" data-price-remove>削除</button></td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>

                <div class="kb-price-actions kb-price-actions-gap">
                  <button type="button" class="btn-secondary" data-price-add>明細行を追加</button>
                  <span class="muted">合計：</span>
                  <strong data-price-total>0</strong><span class="muted">円</span>
                </div>
              </div>

              <div class="form-row">
                <button type="submit" class="btn-primary">このログを保存</button>
              </div>
            </form>
          </details>

          <form method="post" action="/kb/visit/{{ v.id }}/delete"
                onsubmit="return confirm('この利用ログを削除しますか？');">
            <button type="submit" class="btn-secondary">このログを削除</button>
          </form>
        </div>
      {% endfor %}
    {% else %}
      <p class="muted">利用ログはまだありません。</p>
    {% endif %}
  </section>
</main>

{% include "_footer.html" %}
