{% set page_title_suffix = "全レス表示" %}
{% set body_class = "page-thread-posts" %}
{% set active_page = "thread_search" %}
{% include "_header.html" %}

<main>
  <section class="card">
    <div class="section-title">スレッド情報（全レス表示）</div>

    <p class="back-link">
      <a href="/thread_search?area={{ area }}&period={{ period }}&keyword={{ title_keyword|urlencode }}">
        外部検索に戻る
      </a>
    </p>

    {% if error_message %}
      <div class="error">{{ error_message }}</div>
    {% endif %}

    <div class="thread-info">
      <div>タイトル：{{ thread_title or "（取得できませんでした）" }}</div>
      <div class="thread-url">URL：{{ thread_url }}</div>
      {% if posts %}
        <div>取得レス数：{{ posts|length }}件</div>
      {% endif %}

      {% if store_title %}
      <div class="store-search">
        <span class="store-search-label">店舗ページ検索：</span>
        <a
          href="{{ store_cityheaven_url if store_cityheaven_url else ('https://www.google.com/search?q=' ~ ('site:cityheaven.net ' ~ store_title)|urlencode) }}"
          target="_blank"
          rel="noopener noreferrer"
          class="btn-mini"
        >シティヘブン</a>

        <a
          href="{{ store_dto_url if store_dto_url else ('https://www.google.com/search?q=' ~ ('site:dto.jp ' ~ store_title)|urlencode) }}"
          target="_blank"
          rel="noopener noreferrer"
          class="btn-mini"
        >デリヘルタウン</a>

        <a
          href="https://www.google.com/search?q={{ store_title|urlencode }}"
          target="_blank"
          rel="noopener noreferrer"
          class="btn-mini"
        >Google</a>
      </div>
      {% endif %}
    </div>
  </section>

  <section class="card">
    {% if posts and not error_message %}
      <div class="thread-header">
        <h2>全レス（{{ posts|length }}件）</h2>

        <div class="thread-actions">
          {# ★表示切替（デフォルトは view=tree） #}
          <a
            class="btn-sm {% if view == 'tree' %}primary{% endif %}"
            href="/thread_search/showall?url={{ thread_url|urlencode }}&area={{ area|urlencode }}&period={{ period|urlencode }}&title_keyword={{ title_keyword|urlencode }}&view=tree"
          >ツリー表示</a>

          <a
            class="btn-sm {% if view == 'flat' %}primary{% endif %}"
            href="/thread_search/showall?url={{ thread_url|urlencode }}&area={{ area|urlencode }}&period={{ period|urlencode }}&title_keyword={{ title_keyword|urlencode }}&view=flat"
          >時系列表示</a>
        </div>
      </div>

      {% if view == "tree" %}
        {# ★ツリー表示：blockquote のデフォルトインデントを利用（CSS変更なし） #}
        {% macro render_node(node) -%}
          {% set p = node.post %}
          <div class="result" {% if p.post_no %}data-post-no="{{ p.post_no }}"{% endif %}>
            <div class="result-id">
              {% if p.post_no %}レス #{{ p.post_no }}{% else %}レス番号不明{% endif %}
              {% if p.posted_at %}／ {{ p.posted_at }}{% endif %}
            </div>
            <div class="result-text">{{ p.body }}</div>
          </div>

          {% if node.children and node.children|length %}
            <blockquote>
              {% for ch in node.children %}
                {{ render_node(ch) }}
              {% endfor %}
            </blockquote>
          {% endif %}
        {%- endmacro %}

        {% for node in tree_roots %}
          {{ render_node(node) }}
        {% endfor %}

        {% if posts_unknown and posts_unknown|length %}
          <h3>レス番号不明（{{ posts_unknown|length }}件）</h3>
          {% for p in posts_unknown %}
            <div class="result">
              <div class="result-id">
                レス番号不明
                {% if p.posted_at %}／ {{ p.posted_at }}{% endif %}
              </div>
              <div class="result-text">{{ p.body }}</div>
            </div>
          {% endfor %}
        {% endif %}

      {% else %}
        {# ★時系列表示（従来） #}
        {% for p in posts %}
          <div class="result" {% if p.post_no %}data-post-no="{{ p.post_no }}"{% endif %}>
            <div class="result-id">
              {% if p.post_no %}レス #{{ p.post_no }}{% else %}レス番号不明{% endif %}
              {% if p.posted_at %}／ {{ p.posted_at }}{% endif %}
            </div>
            <div class="result-text">{{ p.body }}</div>
          </div>
        {% endfor %}
      {% endif %}

    {% elif not error_message %}
      <p class="no-result">レスを取得できませんでした。</p>
    {% endif %}
  </section>
</main>

{% include "_footer.html" %}
