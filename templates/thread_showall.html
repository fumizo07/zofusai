{% set page_title_suffix = "全レス表示" %}
{% set body_class = "page-thread-posts" %}
{% set active_page = "thread_search" %}
{% include "_header.html" %}

{# ★no_log 組み立て禁止。back_url が無ければ /thread_search #}
{% set _back_url = back_url or "/thread_search" %}

<button class="hamburger-button" id="hamburgerButton" type="button">
    <span class="hamburger-button-inner">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
    </span>
</button>

<div class="quick-menu-overlay" id="quickMenuOverlay">
    <div class="quick-menu-panel">
        <div class="quick-menu-header">
            <div class="quick-menu-title">メニュー</div>
            <button type="button" class="quick-menu-close" aria-label="閉じる"></button>
        </div>
        <div class="quick-menu-content">

            <div class="quick-menu-section">
                <div class="quick-menu-section-title">スレッド情報</div>
                <div style="font-size:13px;">
                    <div>タイトル：{{ thread_title or "（取得できませんでした）" }}</div>
                    <div class="thread-url">URL：{{ thread_url }}</div>
                    <div>
                        カテゴリ：<strong>{{ board_category_label or '（未指定）' }}</strong><br>
                        板：<strong>{{ board_label or '（未指定）' }}</strong>
                    </div>
                    <div>
                        タイトルキーワード：<strong>{{ title_keyword or '（未指定）' }}</strong><br>
                        本文キーワード：<strong>{{ post_keyword or '（未指定）' }}</strong>
                    </div>
                </div>
            </div>

            <div class="quick-menu-section">
                <div class="quick-menu-section-title">別キーワードで再検索</div>
                <form method="post" action="/thread_search/posts" class="quick-menu-form">
                    <input type="hidden" name="selected_thread" value="{{ thread_url|e }}">
                    <input type="hidden" name="area" value="{{ area }}">
                    <input type="hidden" name="period" value="{{ period }}">
                    <input type="hidden" name="board_category" value="{{ board_category|e }}">
                    <input type="hidden" name="board_id" value="{{ board_id|e }}">
                    <input type="hidden" name="title_keyword" value="{{ title_keyword|e }}">
                    <input type="hidden" name="back_url" value="{{ _back_url|e }}">

                    <div class="form-row">
                        <label>本文キーワード：</label>
                        <input type="text" name="post_keyword" value="{{ post_keyword|e }}">
                    </div>

                    <div class="form-row">
                        <button type="submit" class="btn-primary">このスレで再検索</button>
                    </div>
                </form>
            </div>

            {% if not error_message %}
            <div class="quick-menu-section">
                <div class="quick-menu-section-title">保存</div>
                <form method="post" action="/thread_search/save">
                    <input type="hidden" name="thread_url" value="{{ thread_url|e }}">
                    <input type="hidden" name="back_url" value="{{ _back_url|e }}">
                    <button type="submit" class="btn-secondary">このスレを保存</button>
                </form>
            </div>
            {% endif %}

            <div class="quick-menu-section">
                <div class="quick-menu-section-title">スレ検索</div>
                <div class="quick-menu-links">
                    <a href="{{ _back_url|e }}">外部検索に戻る</a>
                    <a href="/">内部検索に戻る</a>
                </div>
            </div>

        </div>
    </div>
</div>

<main>
  <section class="card">
    <div class="section-title">スレッド情報（全レス表示）</div>

    <p class="back-link">
      <a href="{{ _back_url|e }}">外部検索に戻る</a>
    </p>

    {% if error_message %}
      <div class="error">{{ error_message }}</div>
    {% endif %}

    <div class="thread-info">
      <div>タイトル：{{ thread_title or "（取得できませんでした）" }}</div>
      <div class="thread-url">URL：{{ thread_url }}</div>
      {% if posts %}
        <div>取得レス数：{{ posts|length }}件</div>
      {% endif %}

      {% if store_title %}
      <div class="store-search">
        <span class="store-search-label">店舗ページ検索：</span>
        <a
          href="{{ store_cityheaven_url if store_cityheaven_url else ('https://www.google.com/search?q=' ~ ('site:cityheaven.net ' ~ store_title)|urlencode) }}"
          target="_blank"
          rel="noopener noreferrer"
          class="btn-mini"
        >シティヘブン</a>

        <a
          href="{{ store_dto_url if store_dto_url else ('https://www.google.com/search?q=' ~ ('site:dto.jp ' ~ store_title)|urlencode) }}"
          target="_blank"
          rel="noopener noreferrer"
          class="btn-mini"
        >デリヘルタウン</a>

        <a
          href="https://www.google.com/search?q={{ store_title|urlencode }}"
          target="_blank"
          rel="noopener noreferrer"
          class="btn-mini"
        >Google</a>
      </div>
      {% endif %}
    </div>
  </section>

  <section class="card">
    {% if posts and not error_message %}
      <div class="thread-header">
        <h2>全レス（{{ posts|length }}件）</h2>

        <div class="thread-actions">
          <a
            class="btn-sm {% if view == 'tree' %}primary{% endif %}"
            href="/thread_search/showall?url={{ thread_url|urlencode }}&area={{ area|urlencode }}&period={{ period|urlencode }}&board_category={{ board_category|urlencode }}&board_id={{ board_id|urlencode }}&title_keyword={{ title_keyword|urlencode }}&view=tree&back_url={{ _back_url|urlencode }}"
          >ツリー表示</a>

          <a
            class="btn-sm {% if view == 'flat' %}primary{% endif %}"
            href="/thread_search/showall?url={{ thread_url|urlencode }}&area={{ area|urlencode }}&period={{ period|urlencode }}&board_category={{ board_category|urlencode }}&board_id={{ board_id|urlencode }}&title_keyword={{ title_keyword|urlencode }}&view=flat&back_url={{ _back_url|urlencode }}"
          >時系列表示</a>
        </div>
      </div>

      {% if view == "tree" %}
        {% macro render_node(node) -%}
          {% set p = node.post %}
          <div class="result" {% if p.post_no %}data-post-no="{{ p.post_no }}"{% endif %}>
            <div class="result-id">
              {% if p.post_no %}レス #{{ p.post_no }}{% else %}レス番号不明{% endif %}
              {% if p.posted_at %}／ {{ p.posted_at }}{% endif %}
            </div>
            <div class="result-text">{{ p.body }}</div>
          </div>

          {% if node.children and node.children|length %}
            <blockquote>
              {% for ch in node.children %}
                {{ render_node(ch) }}
              {% endfor %}
            </blockquote>
          {% endif %}
        {%- endmacro %}

        {% for node in tree_roots %}
          {{ render_node(node) }}
        {% endfor %}

        {% if posts_unknown and posts_unknown|length %}
          <h3>レス番号不明（{{ posts_unknown|length }}件）</h3>
          {% for p in posts_unknown %}
            <div class="result">
              <div class="result-id">
                レス番号不明
                {% if p.posted_at %}／ {{ p.posted_at }}{% endif %}
              </div>
              <div class="result-text">{{ p.body }}</div>
            </div>
          {% endfor %}
        {% endif %}

      {% else %}
        {% for p in posts %}
          <div class="result" {% if p.post_no %}data-post-no="{{ p.post_no }}"{% endif %}>
            <div class="result-id">
              {% if p.post_no %}レス #{{ p.post_no }}{% else %}レス番号不明{% endif %}
              {% if p.posted_at %}／ {{ p.posted_at }}{% endif %}
            </div>
            <div class="result-text">{{ p.body }}</div>
          </div>
        {% endfor %}
      {% endif %}

    {% elif not error_message %}
      <p class="no-result">レスを取得できませんでした。</p>
    {% endif %}
  </section>
</main>

<div id="anchorPreviewTooltip" class="anchor-preview-tooltip" aria-hidden="true"></div>

{% include "_footer.html" %}
